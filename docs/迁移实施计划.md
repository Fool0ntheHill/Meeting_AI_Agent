# 新项目迁移实施计划

## 🎯 目标

将当前项目重构为**分层架构 + 依赖注入**模式，支持：
- ✅ 面向对象设计（SOLID 原则）
- ✅ 易于扩展和维护
- ✅ 支持 Web API 集成
- ✅ 完善的测试覆盖

---

## 📅 时间规划（10-15 天）

### 阶段 1: 核心抽象层（2 天）

**目标**: 定义接口、数据模型、异常体系

**任务清单**:
- [ ] 创建项目骨架（目录结构）
- [ ] 定义 `ASRProvider` 接口
- [ ] 定义 `VoiceprintProvider` 接口
- [ ] 定义 `LLMProvider` 接口
- [ ] 定义数据模型（`Segment`, `TranscriptionResult` 等）
- [ ] 定义自定义异常（`ASRError`, `VoiceprintError` 等）
- [ ] 编写配置管理（`VolcanoConfig`, `IFlyTekConfig` 等）

**产出**:
```
src/
├── core/
│   ├── interfaces.py      ✅
│   ├── models.py          ✅
│   └── exceptions.py      ✅
└── config/
    └── settings.py        ✅
```

---

### 阶段 2: 提供商实现（4 天）

**目标**: 重构现有代码为提供商模式

#### 2.1 火山引擎 ASR（1 天）

**任务**:
- [ ] 创建 `VolcanoASR` 类，实现 `ASRProvider` 接口
- [ ] 迁移 `volcano_transcriber_v3.py` 的核心逻辑
- [ ] 添加日志和异常处理
- [ ] 编写单元测试

**产出**: `src/providers/asr/volcano.py`

#### 2.2 Azure ASR（1 天）

**任务**:
- [ ] 创建 `AzureASR` 类，实现 `ASRProvider` 接口
- [ ] 迁移 `azure_transcriber.py` 的核心逻辑
- [ ] 处理大文件切分逻辑
- [ ] 编写单元测试

**产出**: `src/providers/asr/azure.py`

#### 2.3 讯飞声纹识别（1 天）

**任务**:
- [ ] 创建 `IFlyTekVoiceprint` 类，实现 `VoiceprintProvider` 接口
- [ ] 迁移 `iflytek_voiceprint.py` 的核心逻辑
- [ ] 保留分差挽救机制
- [ ] 编写单元测试

**产出**: `src/providers/voiceprint/iflytek.py`

#### 2.4 Gemini LLM（1 天）

**任务**:
- [ ] 创建 `GeminiLLM` 类，实现 `LLMProvider` 接口
- [ ] 改造 `meeting_summarizer.py` 为 Gemini API
- [ ] 支持多种总结策略
- [ ] 编写单元测试

**产出**: `src/providers/llm/gemini.py`

---

### 阶段 3: 业务逻辑层（3 天）

**目标**: 实现业务逻辑，组合各个提供商

#### 3.1 转写服务（1 天）

**任务**:
- [ ] 创建 `TranscriptionService` 类
- [ ] 实现 `process_meeting()` 主流程
- [ ] 集成 ASR 提供商
- [ ] 添加重试和降级逻辑（火山失败 → Azure）
- [ ] 编写集成测试

**产出**: `src/services/transcription.py`

#### 3.2 说话人识别服务（1 天）

**任务**:
- [ ] 创建 `SpeakerRecognitionService` 类
- [ ] 迁移 `audio_processor.py` 的音频提取逻辑
- [ ] 集成声纹识别提供商
- [ ] 实现样本筛选和识别流程
- [ ] 编写集成测试

**产出**: `src/services/speaker_recognition.py`

#### 3.3 ASR 修正服务（1 天）

**任务**:
- [ ] 创建 `CorrectionService` 类
- [ ] 迁移 `asr_cluster_corrector.py` 的修正逻辑
- [ ] 实现全局身份选举
- [ ] 实现异常点清洗
- [ ] 编写集成测试

**产出**: `src/services/correction.py`

---

### 阶段 4: API 层（2 天）

**目标**: 实现 Web API 接口

#### 4.1 API Schema 定义（0.5 天）

**任务**:
- [ ] 定义请求模型（`TranscriptionRequest`, `SummarizationRequest` 等）
- [ ] 定义响应模型（`TranscriptionResponse`, `ErrorResponse` 等）
- [ ] 定义枚举类型（`ASRProvider`, `Strategy` 等）

**产出**: `src/api/schemas.py`

#### 4.2 路由实现（1 天）

**任务**:
- [ ] 实现 `/api/v1/transcribe` 接口（转写）
- [ ] 实现 `/api/v1/identify` 接口（说话人识别）
- [ ] 实现 `/api/v1/summarize` 接口（总结）
- [ ] 实现 `/api/v1/process` 接口（完整流程）
- [ ] 添加异常处理中间件

**产出**: `src/api/routes.py`

#### 4.3 依赖注入（0.5 天）

**任务**:
- [ ] 实现 `get_config()` 依赖
- [ ] 实现 `get_asr_provider()` 依赖
- [ ] 实现 `get_voiceprint_provider()` 依赖
- [ ] 实现 `get_transcription_service()` 依赖

**产出**: `src/api/dependencies.py`

---

### 阶段 5: 工具模块（2 天）

**目标**: 实现通用工具和辅助功能

#### 5.1 音频处理（0.5 天）

**任务**:
- [ ] 创建 `AudioProcessor` 类
- [ ] 实现音频格式转换
- [ ] 实现音频片段提取
- [ ] 实现音频信息获取

**产出**: `src/utils/audio.py`

#### 5.2 存储操作（0.5 天）

**任务**:
- [ ] 创建 `StorageClient` 类
- [ ] 实现 TOS 上传/下载
- [ ] 实现本地文件操作
- [ ] 实现临时文件管理

**产出**: `src/utils/storage.py`

#### 5.3 日志系统（0.5 天）

**任务**:
- [ ] 配置结构化日志（JSON 格式）
- [ ] 实现日志轮转
- [ ] 实现日志级别控制
- [ ] 集成到所有模块

**产出**: `src/utils/logger.py`

#### 5.4 评估指标（0.5 天）

**任务**:
- [ ] 提取 CER 计算逻辑
- [ ] 提取 DER 计算逻辑
- [ ] 提取时间戳偏移计算逻辑
- [ ] 编写单元测试

**产出**: `src/utils/metrics.py`

---

### 阶段 6: 测试与文档（2 天）

**目标**: 完善测试和文档

#### 6.1 单元测试（1 天）

**任务**:
- [ ] 为所有提供商编写单元测试
- [ ] 为所有服务编写单元测试
- [ ] 为工具模块编写单元测试
- [ ] 测试覆盖率 > 80%

**产出**: `tests/unit/`

#### 6.2 集成测试（0.5 天）

**任务**:
- [ ] 编写端到端测试
- [ ] 编写 API 测试
- [ ] 编写性能测试

**产出**: `tests/integration/`

#### 6.3 文档（0.5 天）

**任务**:
- [ ] 编写 README.md
- [ ] 编写 API 文档（OpenAPI）
- [ ] 编写部署文档
- [ ] 编写开发指南

**产出**: `docs/`

---

## 🔧 技术栈

### 核心依赖

```txt
# Web 框架
fastapi==0.109.0
uvicorn[standard]==0.27.0

# 数据验证
pydantic==2.5.0
pydantic-settings==2.1.0

# HTTP 客户端
requests==2.31.0
httpx==0.26.0

# 音频处理
pydub==0.25.1

# 存储
tos==2.6.0

# LLM
google-generativeai==0.3.0

# 日志
structlog==24.1.0

# 测试
pytest==7.4.0
pytest-asyncio==0.21.0
pytest-cov==4.1.0

# 代码质量
black==23.12.0
ruff==0.1.0
mypy==1.7.0
```

---

## 📂 最终目录结构

```
新项目/
├── src/
│   ├── __init__.py
│   │
│   ├── core/                      # 核心抽象层
│   │   ├── __init__.py
│   │   ├── interfaces.py          # 接口定义
│   │   ├── models.py              # 数据模型
│   │   └── exceptions.py          # 自定义异常
│   │
│   ├── config/                    # 配置管理
│   │   ├── __init__.py
│   │   ├── settings.py            # 配置类
│   │   └── loader.py              # 配置加载器
│   │
│   ├── providers/                 # 服务提供商实现
│   │   ├── __init__.py
│   │   ├── asr/                   # ASR 提供商
│   │   │   ├── __init__.py
│   │   │   ├── base.py            # ASR 基类
│   │   │   ├── volcano.py         # 火山引擎实现
│   │   │   └── azure.py           # Azure 实现
│   │   │
│   │   ├── voiceprint/            # 声纹识别提供商
│   │   │   ├── __init__.py
│   │   │   ├── base.py
│   │   │   └── iflytek.py
│   │   │
│   │   └── llm/                   # LLM 提供商
│   │       ├── __init__.py
│   │       ├── base.py
│   │       └── gemini.py
│   │
│   ├── services/                  # 业务逻辑层
│   │   ├── __init__.py
│   │   ├── transcription.py       # 转写服务
│   │   ├── speaker_recognition.py # 说话人识别服务
│   │   ├── correction.py          # ASR 修正服务
│   │   └── summarization.py       # 总结服务
│   │
│   ├── utils/                     # 工具模块
│   │   ├── __init__.py
│   │   ├── audio.py               # 音频处理
│   │   ├── storage.py             # 存储操作
│   │   ├── logger.py              # 日志工具
│   │   └── metrics.py             # 评估指标
│   │
│   └── api/                       # API 层（Web 接口）
│       ├── __init__.py
│       ├── schemas.py             # 请求/响应模型
│       ├── routes.py              # 路由定义
│       ├── dependencies.py        # 依赖注入
│       └── middleware.py          # 中间件
│
├── tests/                         # 测试
│   ├── __init__.py
│   ├── unit/                      # 单元测试
│   ├── integration/               # 集成测试
│   └── fixtures/                  # 测试数据
│
├── config/                        # 配置文件
│   ├── development.yaml
│   ├── production.yaml
│   └── test.yaml
│
├── scripts/                       # 脚本工具
│   ├── migrate_data.py
│   └── register_speakers.py
│
├── docs/                          # 文档
│   ├── api.md
│   ├── deployment.md
│   └── development.md
│
├── AI参考文件夹/                  # 旧项目参考代码
│   ├── 1_ASR转写/
│   ├── 2_声纹识别/
│   └── ...
│
├── .env.example                   # 环境变量示例
├── .gitignore
├── requirements.txt
├── setup.py
├── pytest.ini
├── pyproject.toml                 # 项目配置
├── README.md
└── main.py                        # 主入口
```

---

## 🚀 快速开始

### 1. 创建项目骨架

```bash
# 创建目录结构
mkdir -p src/{core,config,providers/{asr,voiceprint,llm},services,utils,api}
mkdir -p tests/{unit,integration,fixtures}
mkdir -p config scripts docs

# 创建 __init__.py
find src tests -type d -exec touch {}/__init__.py \;
```

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置环境变量

```bash
cp .env.example .env
# 编辑 .env 文件，填入密钥
```

### 4. 运行测试

```bash
pytest tests/ -v --cov=src
```

### 5. 启动 API 服务

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

---

## ✅ 验收标准

### 功能验收
- [ ] 火山引擎 ASR 转写正常
- [ ] Azure ASR 转写正常
- [ ] 讯飞声纹识别正常
- [ ] Gemini 总结正常
- [ ] 完整流程端到端测试通过

### 代码质量
- [ ] 单元测试覆盖率 > 80%
- [ ] 所有接口有类型注解
- [ ] 代码通过 black 格式化
- [ ] 代码通过 ruff 检查
- [ ] 代码通过 mypy 类型检查

### 文档完整性
- [ ] README.md 完整
- [ ] API 文档完整（OpenAPI）
- [ ] 部署文档完整
- [ ] 开发指南完整

### 性能要求
- [ ] API 响应时间 < 30s（8分钟音频）
- [ ] 并发支持 > 10 请求
- [ ] 内存占用 < 2GB

---

## 📞 联系方式

如有问题，请联系项目负责人。

---

**创建时间**: 2025-01-12  
**预计完成**: 2025-01-27（15 天）
