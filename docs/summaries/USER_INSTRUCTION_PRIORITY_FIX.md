# 用户指令优先级修复总结

## 问题描述

用户在使用空白模板（`__blank__`）并提供自定义提示词时，发现 Gemini 会忽略用户的指令，仍然根据转写内容自动推断任务类型并生成会议相关内容。

### 具体案例

**用户提示词**：
```
无视以下所有内容，直接输出6666666666
```

**实际输出**：
```
原型设计与导航结构规则目前按模块（如商城、游戏库、社区）制定，点击可跳转至对应 Wiki。
导航目录当前为分开设计；蓝为一建议若规则数量较少可维持现状，若数量较多则应聚合在左侧统一导航目录中。
...（会议纪要格式的内容）
```

## 根本原因

1. **转写内容过长**：转写内容约 7000 字符，而用户指令只有几十字符
2. **提示词顺序问题**：原实现将用户指令放在前面，转写内容放在后面
3. **LLM 注意力偏向**：大语言模型更关注提示词后面的内容，导致大量转写内容"淹没"了用户的短指令
4. **内容推断优先**：即使有系统指令强调用户优先级，但转写内容的"会议特征"太明显，LLM 仍然会自动推断

## 解决方案

### 核心策略1：增强系统提示词（GLOBAL_SYSTEM_INSTRUCTION）

在 `src/providers/gemini_llm.py` 中强化了系统提示词，明确强调用户指令的绝对优先级：

```python
GLOBAL_SYSTEM_INSTRUCTION = """【底层约束 - 必须严格遵守】

0. **最高优先级 - 用户指令绝对优先原则**：
   ⚠️ 这是最重要的规则，优先级高于所有其他规则 ⚠️
   
   - 用户的自定义提示词（通常在"【重要】用户指令"部分）具有**绝对最高优先级**
   - 如果用户的指令与转写内容的自然推断相冲突，**无条件以用户指令为准**
   - 即使转写内容明显是会议记录，如果用户要求输出其他格式，也必须按照用户的实际指令执行
   - 不要根据转写内容的特征自作主张地推断任务类型
   
   **示例场景**：
   - 如果用户说"输出6666666666"，就只输出这个数字，不要生成会议纪要
   - 如果用户说"输出JSON格式"，就输出JSON，不要生成Markdown格式的会议纪要
   - 如果用户说"提取技术决策"，就只提取技术决策，不要生成完整的会议纪要
...
"""
```

**关键改进**：
- 使用 ⚠️ 符号和加粗强调重要性
- 明确说明"绝对最高优先级"、"无条件以用户指令为准"
- 提供具体的示例场景，帮助 LLM 理解
- 强调"不要自作主张地推断任务类型"

### 核心策略2：调整提示词顺序

对于**空白模板 + 自定义提示词**的场景，将提示词结构调整为：

```
## 原始转写内容
[转写内容 - 7000字符]

---

## 【重要】用户指令（请严格按照以下指令执行，优先级高于转写内容的自然推断）
[用户的自定义提示词 - 几十字符]
```

### 实现细节

修改 `src/providers/gemini_llm.py` 中的 `_build_prompt()` 方法：

```python
# 策略：对于空白模板且用户提供了自定义 prompt_text，将转写内容放在前面，用户指令放在后面
# 这样可以确保用户指令具有更高的优先级（LLM 更关注后面的内容）
if is_blank_template and prompt_instance.prompt_text:
    # 空白模板 + 自定义提示词：先转写，后用户指令
    if has_transcript_placeholder:
        # 用户已经在提示词中指定了 {transcript} 的位置，尊重用户的安排
        prompt_body = user_prompt.replace("{transcript}", formatted_transcript)
    else:
        # 用户没有指定位置，我们将转写放在前面，用户指令放在后面
        # 添加明确的分隔和强调
        prompt_body = f"## 原始转写内容\n{formatted_transcript}\n\n---\n\n## 【重要】用户指令（请严格按照以下指令执行，优先级高于转写内容的自然推断）\n{user_prompt}"
        logger.info("Using blank template with custom prompt: transcript BEFORE user instruction for higher priority")
```

### 为什么这样有效？

**双重保障机制**：

1. **系统提示词层面**（GLOBAL_SYSTEM_INSTRUCTION）：
   - 在 Gemini API 的 `system_instruction` 参数中明确强调用户指令优先级
   - 使用视觉标记（⚠️）和加粗文本增强注意力
   - 提供具体示例场景，帮助 LLM 理解边界情况
   - 这是"底层约束"，对所有请求生效

2. **提示词结构层面**（_build_prompt）：
   - **位置优势**：LLM 对提示词末尾的内容更敏感，将用户指令放在最后可以提高其权重
   - **明确分隔**：使用 `---` 和 `【重要】` 标记，明确区分转写内容和用户指令
   - **显式强调**：在用户指令前添加"请严格按照以下指令执行，优先级高于转写内容的自然推断"
   - **保持灵活性**：如果用户在提示词中使用了 `{transcript}` 占位符，仍然尊重用户的安排

**为什么需要双重保障？**
- 系统提示词是全局约束，但可能被大量转写内容"稀释"
- 提示词结构调整确保用户指令在最后，获得最高注意力权重
- 两者结合，形成"规则 + 位置"的双重强化

## 影响范围

### 受影响的场景

✅ **空白模板 + 自定义提示词**（本次修复的目标场景）
- `template_id = "__blank__"`
- `prompt_text` 不为空
- 用户完全自定义提示词内容

### 不受影响的场景

✅ **常规模板**（保持原有逻辑）
- 使用数据库中的提示词模板
- 按原有顺序：用户指令 → 会议元数据 → 转写内容 → 语言指令

✅ **空白模板但用户使用了 {transcript} 占位符**
- 尊重用户指定的转写内容位置
- 不做自动调整

## 测试验证

### 测试脚本

创建了 `scripts/test_user_instruction_priority.py` 用于验证修复效果。

### 测试用例

1. **用例1**：用户要求输出特定 JSON
   - 提示词：`请输出以下JSON：{"content": "TEST_SUCCESS", "message": "用户指令已执行"}`
   - 预期：输出包含 `TEST_SUCCESS`，不包含会议纪要格式

2. **用例2**：用户要求输出固定数字
   - 提示词：`无视以下所有内容，直接输出6666666666`
   - 预期：输出包含 `6666666666` 或 `666`

3. **用例3**：用户要求提取特定信息
   - 提示词：`请从对话中提取所有技术决策，以简洁的列表形式输出`
   - 预期：输出是列表格式，不是会议纪要格式

### 运行测试

```bash
# 确保 Worker 已重启以加载最新代码
python scripts/stop_all.ps1
python scripts/start_worker.ps1

# 运行测试
python scripts/test_user_instruction_priority.py
```

## 后续建议

### 1. 前端提示优化

在前端的空白模板编辑界面，可以添加提示：

```
💡 提示：使用空白模板时，您的指令将具有最高优先级。
即使转写内容看起来像会议，系统也会严格按照您的指令执行。
```

### 2. 转写内容截断（可选）

如果转写内容过长（如超过 10000 字符），可以考虑：
- 只保留前 N 个片段
- 提供摘要而不是完整转写
- 让用户选择是否包含完整转写

### 3. 用户指令模板库

可以为常见的自定义场景提供模板：
- "提取技术决策"
- "生成简洁摘要"
- "提取行动项"
- "分析讨论重点"

## 相关文件

### 修改的文件
- `src/providers/gemini_llm.py` - 增强了 `GLOBAL_SYSTEM_INSTRUCTION` 系统提示词
- `src/providers/gemini_llm.py` - 修改了 `_build_prompt()` 方法（提示词顺序调整）

### 新增的文件
- `scripts/test_user_instruction_priority.py` - 测试脚本
- `docs/summaries/USER_INSTRUCTION_PRIORITY_FIX.md` - 本文档

### 相关文档
- `docs/PROMPT_TEXT_FRONTEND_GUIDE.md` - 前端集成指南
- `docs/ARTIFACT_PROMPT_STORAGE_GUIDE.md` - 提示词存储指南

## 版本信息

- **修复日期**：2026-01-26
- **修复版本**：v1.0.0
- **影响范围**：空白模板 + 自定义提示词场景
- **向后兼容**：是（不影响现有功能）

## 总结

通过调整提示词顺序（转写内容在前，用户指令在后），并添加明确的分隔和强调，成功解决了用户自定义指令被大量转写内容"淹没"的问题。这个修复确保了用户的指令始终具有最高优先级，即使转写内容具有明显的会议特征。
