# ä¼å¾®é€šçŸ¥æ ¼å¼æ›´æ–° - æ ‡å‡† Markdown

**æ—¥æœŸ**: 2026-01-27  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## é—®é¢˜æè¿°

ä¼å¾®é€šçŸ¥ç›®å‰ä½¿ç”¨çš„æ˜¯ ATP å¯Œæ–‡æœ¬æ ¼å¼ï¼ˆ`<i>`, `<b>`, `<br>`, `<a>` ç­‰ HTML æ ‡ç­¾ï¼‰ï¼Œéœ€è¦æ”¹æˆæ ‡å‡† Markdown æ ¼å¼ä»¥æé«˜å…¼å®¹æ€§å’Œå¯è¯»æ€§ã€‚

### åŸæ ¼å¼ï¼ˆATP å¯Œæ–‡æœ¬ï¼‰

```
<i>âœ… ä¼šè®®çºªè¦ç”ŸæˆæˆåŠŸ</i><br><br><b>ä¼šè®®åç§°</b>: æµ‹è¯•ä¼šè®®<br><b>ä¼šè®®æ—¶é—´</b>: 2026-01-27 22:00<br><b>ç”Ÿæˆå†…å®¹</b>: çºªè¦<br><br>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br><br><i>ğŸ“„ <a href="...">ç‚¹å‡»æŸ¥çœ‹ä¼šè®®çºªè¦</a></i>
```

### æ–°æ ¼å¼ï¼ˆæ ‡å‡† Markdownï¼‰

```markdown
âœ… **ä¼šè®®çºªè¦ç”ŸæˆæˆåŠŸ**

**ä¼šè®®åç§°**: æµ‹è¯•ä¼šè®®
**ä¼šè®®æ—¶é—´**: 2026-01-27 22:00
**ç”Ÿæˆå†…å®¹**: çºªè¦

---

ğŸ“„ [ç‚¹å‡»æŸ¥çœ‹ä¼šè®®çºªè¦](...)
```

## ä¿®æ”¹å†…å®¹

### 1. æˆåŠŸé€šçŸ¥æ ¼å¼

**æ–‡ä»¶**: `src/utils/wecom_notification.py`

**ä¿®æ”¹å‰**:
```python
message = f"""<i>âœ… ä¼šè®®çºªè¦ç”ŸæˆæˆåŠŸ</i><br><br><b>ä¼šè®®åç§°</b>: {task_name or 'æœªå‘½åä¼šè®®'}<br><b>ä¼šè®®æ—¶é—´</b>: {meeting_datetime}<br><b>ç”Ÿæˆå†…å®¹</b>: {artifact_display}<br><br>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br><br><i>ğŸ“„ <a href="{workspace_url}">ç‚¹å‡»æŸ¥çœ‹ä¼šè®®çºªè¦</a></i>"""
```

**ä¿®æ”¹å**:
```python
message = f"""âœ… **ä¼šè®®çºªè¦ç”ŸæˆæˆåŠŸ**

**ä¼šè®®åç§°**: {task_name or 'æœªå‘½åä¼šè®®'}
**ä¼šè®®æ—¶é—´**: {meeting_datetime}
**ç”Ÿæˆå†…å®¹**: {artifact_display}

---

ğŸ“„ [ç‚¹å‡»æŸ¥çœ‹ä¼šè®®çºªè¦]({workspace_url})"""
```

### 2. å¤±è´¥é€šçŸ¥æ ¼å¼

**ä¿®æ”¹å‰**:
```python
message = f"""<e>âŒ ä¼šè®®çºªè¦ç”Ÿæˆå¤±è´¥</e><br><br><b>ä¼šè®®åç§°</b>: {task_name or 'æœªå‘½åä¼šè®®'}<br><b>ä¼šè®®æ—¶é—´</b>: {meeting_datetime}<br><br><w>é”™è¯¯ä¿¡æ¯</w>: {error_message or 'æœªçŸ¥é”™è¯¯'}<br><c>é”™è¯¯ç : {error_code or 'UNKNOWN'}</c><br><br>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br><br><i>ğŸ”§ <a href="{workbench_url}">å‰å¾€å·¥ä½œå°æŸ¥çœ‹è¯¦æƒ…</a></i>"""
```

**ä¿®æ”¹å**:
```python
message = f"""âŒ **ä¼šè®®çºªè¦ç”Ÿæˆå¤±è´¥**

**ä¼šè®®åç§°**: {task_name or 'æœªå‘½åä¼šè®®'}
**ä¼šè®®æ—¶é—´**: {meeting_datetime}

**é”™è¯¯ä¿¡æ¯**: {error_message or 'æœªçŸ¥é”™è¯¯'}
**é”™è¯¯ç **: {error_code or 'UNKNOWN'}

---

ğŸ”§ [å‰å¾€å·¥ä½œå°æŸ¥çœ‹è¯¦æƒ…]({workbench_url})"""
```

### 3. Pipeline é€šçŸ¥è°ƒç”¨æ›´æ–°

**æ–‡ä»¶**: `src/services/pipeline.py`

æ·»åŠ äº†å¯¹æ–°å¢ä»»åŠ¡çš„ä¼å¾®é€šçŸ¥æ”¯æŒï¼ŒåŒ…æ‹¬ï¼š

#### æˆåŠŸé€šçŸ¥
```python
# è·å–ä»»åŠ¡åç§°å’Œä¼šè®®æ—¶é—´
task = self.tasks.get_by_id(task_id)
task_name = task.task_name if task else None

wecom_service.send_artifact_success_notification(
    user_account=user_account,
    task_id=task_id,
    task_name=task_name,
    meeting_date=meeting_date,
    meeting_time=meeting_time,
    artifact_id=artifact.artifact_id,
    artifact_type="meeting_minutes",
    display_name="çºªè¦",
)
```

#### å¤±è´¥é€šçŸ¥
```python
wecom_service.send_artifact_failure_notification(
    user_account=user_account,
    task_id=task_id,
    task_name=task_name,
    meeting_date=meeting_date if 'meeting_date' in locals() else None,
    meeting_time=meeting_time if 'meeting_time' in locals() else None,
    error_code=error_code,
    error_message=error_message,
)
```

## æ ¼å¼å¯¹æ¯”

| å…ƒç´  | ATP å¯Œæ–‡æœ¬ | æ ‡å‡† Markdown |
|------|-----------|--------------|
| ç²—ä½“ | `<b>æ–‡æœ¬</b>` | `**æ–‡æœ¬**` |
| æ–œä½“ | `<i>æ–‡æœ¬</i>` | `*æ–‡æœ¬*` æˆ– `_æ–‡æœ¬_` |
| æ¢è¡Œ | `<br>` | ç©ºè¡Œ |
| åˆ†éš”çº¿ | `â”â”â”â”â”â”` | `---` |
| é“¾æ¥ | `<a href="url">æ–‡æœ¬</a>` | `[æ–‡æœ¬](url)` |
| è­¦å‘Šè‰² | `<w>æ–‡æœ¬</w>` | æ™®é€šæ–‡æœ¬ |
| é”™è¯¯è‰² | `<e>æ–‡æœ¬</e>` | æ™®é€šæ–‡æœ¬ |
| ä»£ç è‰² | `<c>æ–‡æœ¬</c>` | æ™®é€šæ–‡æœ¬ |

## ä¼˜åŠ¿

1. **æ ‡å‡†åŒ–**: Markdown æ˜¯é€šç”¨æ ‡å‡†ï¼Œå…¼å®¹æ€§æ›´å¥½
2. **å¯è¯»æ€§**: å³ä½¿åœ¨ä¸æ”¯æŒå¯Œæ–‡æœ¬çš„ç¯å¢ƒä¸­ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤º
3. **å¯ç»´æŠ¤æ€§**: æ ¼å¼æ›´æ¸…æ™°ï¼Œæ˜“äºä¿®æ”¹å’Œè°ƒè¯•
4. **ç®€æ´æ€§**: ä»£ç æ›´ç®€æ´ï¼Œä¸éœ€è¦å¤§é‡ HTML æ ‡ç­¾

## æµ‹è¯•

### æµ‹è¯•è„šæœ¬

è¿è¡Œ `scripts/test_wecom_markdown_format.py` æµ‹è¯•æ–°æ ¼å¼ï¼š

```bash
python scripts/test_wecom_markdown_format.py
```

### æµ‹è¯•åœºæ™¯

1. âœ… æˆåŠŸé€šçŸ¥ - åŒ…å«å®Œæ•´çš„ä¼šè®®ä¿¡æ¯å’Œé“¾æ¥
2. âœ… å¤±è´¥é€šçŸ¥ - åŒ…å«é”™è¯¯ç å’Œé”™è¯¯æ¶ˆæ¯
3. âœ… Pipeline æ–°å¢ä»»åŠ¡ - è‡ªåŠ¨å‘é€é€šçŸ¥
4. âœ… é‡æ–°ç”Ÿæˆ - é€šè¿‡ API è§¦å‘çš„é€šçŸ¥
5. âœ… ç”Ÿæˆæ–°çºªè¦ - é€šè¿‡ API è§¦å‘çš„é€šçŸ¥

## å½±å“èŒƒå›´

### å·²æ›´æ–°çš„æ–‡ä»¶

1. `src/utils/wecom_notification.py` - é€šçŸ¥æ ¼å¼æ›´æ–°
2. `src/services/pipeline.py` - æ·»åŠ  Pipeline é€šçŸ¥æ”¯æŒ
3. `scripts/test_wecom_markdown_format.py` - æ–°å¢æµ‹è¯•è„šæœ¬

### å·²æ”¯æŒçš„åœºæ™¯

1. âœ… **æ–°å¢ä»»åŠ¡** - Pipeline å®Œæˆæ—¶è‡ªåŠ¨å‘é€ï¼ˆæœ¬æ¬¡æ–°å¢ï¼‰
2. âœ… **é‡æ–°ç”Ÿæˆ** - é€šè¿‡ `/artifacts/regenerate` API
3. âœ… **ç”Ÿæˆæ–°çºªè¦** - é€šè¿‡ `/artifacts/generate` API
4. âœ… **è¯´è¯äººæ ¡æ­£åé‡æ–°ç”Ÿæˆ** - é€šè¿‡ `/corrections/apply` API

### å‘åå…¼å®¹æ€§

- âœ… å®Œå…¨å‘åå…¼å®¹
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… ä¼å¾® API åŒæ—¶æ”¯æŒ ATP å’Œ Markdown æ ¼å¼

## éªŒè¯æ¸…å•

- [x] æˆåŠŸé€šçŸ¥æ ¼å¼æ­£ç¡®
- [x] å¤±è´¥é€šçŸ¥æ ¼å¼æ­£ç¡®
- [x] Pipeline æ–°å¢ä»»åŠ¡å‘é€é€šçŸ¥
- [x] é‡æ–°ç”Ÿæˆå‘é€é€šçŸ¥
- [x] ç”Ÿæˆæ–°çºªè¦å‘é€é€šçŸ¥
- [x] é“¾æ¥å¯ç‚¹å‡»è·³è½¬
- [x] ä¼šè®®æ—¶é—´æ­£ç¡®æ˜¾ç¤º
- [x] ä»»åŠ¡åç§°æ­£ç¡®æ˜¾ç¤º
- [x] é”™è¯¯ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

## ç›¸å…³æ–‡ä»¶

- `src/utils/wecom_notification.py` - ä¼å¾®é€šçŸ¥æœåŠ¡
- `src/services/pipeline.py` - Pipeline æœåŠ¡ï¼ˆæ–°å¢é€šçŸ¥ï¼‰
- `src/api/routes/artifacts.py` - Artifact APIï¼ˆå·²æœ‰é€šçŸ¥ï¼‰
- `src/api/routes/corrections.py` - æ ¡æ­£ APIï¼ˆå·²æœ‰é€šçŸ¥ï¼‰
- `scripts/test_wecom_markdown_format.py` - æµ‹è¯•è„šæœ¬
- `docs/WECOM_NOTIFICATION_INTEGRATION.md` - é›†æˆæ–‡æ¡£

## æ€»ç»“

æˆåŠŸå°†ä¼å¾®é€šçŸ¥æ ¼å¼ä» ATP å¯Œæ–‡æœ¬æ›´æ–°ä¸ºæ ‡å‡† Markdown æ ¼å¼ï¼Œæé«˜äº†å¯è¯»æ€§å’Œå…¼å®¹æ€§ã€‚åŒæ—¶è¡¥å……äº† Pipeline æ–°å¢ä»»åŠ¡çš„é€šçŸ¥åŠŸèƒ½ï¼Œç°åœ¨æ‰€æœ‰åœºæ™¯éƒ½èƒ½æ­£ç¡®å‘é€ä¼å¾®é€šçŸ¥ã€‚
