# 说话人识别阈值调优说明

## 概述

本文档说明了说话人识别（声纹识别）的阈值配置和分差挽救机制。

## 当前阈值配置

### 高置信度阈值 (score_threshold)

**当前值**: `0.60`

- **含义**: 高置信度识别的分数阈值
- **范围**: 0.0 - 1.0
- **说明**: 
  - 分数 >= 0.60 会被直接识别（高置信度）
  - 分数 < 0.60 会进入分差挽救判断

### 最低容忍分数 (min_accept_score)

**当前值**: `0.40`

- **含义**: 分差挽救的最低分数要求
- **范围**: 0.0 - 1.0
- **说明**:
  - 分数 < 0.40 会被直接拒绝（防止完全是噪音）
  - 分数 >= 0.40 才有资格进入分差挽救判断

### 分差挽救阈值 (gap_threshold)

**当前值**: `0.15`

- **含义**: 第一名和第二名分数差的最小要求
- **范围**: 0.0 - 1.0
- **说明**:
  - 分差 >= 0.15 说明第一名显著高于第二名
  - 分差 < 0.15 说明结果不够确定，会被拒绝

## 分差挽救机制工作原理

系统使用**三级判断机制**来确保识别准确性：

### 判断流程

```
输入: Top-1 分数, Top-2 分数

┌─────────────────────────────────┐
│ 情况 A: 高置信度                 │
│ Top-1 >= 0.60?                  │
│ ✓ 是 → 直接识别成功              │
└─────────────────────────────────┘
         ↓ 否
┌─────────────────────────────────┐
│ 情况 B: 分差挽救                 │
│ Top-1 >= 0.40 且                │
│ (Top-1 - Top-2) >= 0.15?        │
│ ✓ 是 → 分差挽救成功              │
└─────────────────────────────────┘
         ↓ 否
┌─────────────────────────────────┐
│ 情况 C: 完全拒绝                 │
│ 保持原始 "Speaker X" 标签        │
└─────────────────────────────────┘
```

### 1. 高置信度识别
```python
if top_score >= 0.60:
    return 识别成功  # 分数足够高，直接采纳
```

### 2. 分差挽救机制
```python
if top_score >= 0.40 and score_gap >= 0.15:
    return 识别成功（分差挽救）  # 虽然分数不高，但显著高于第二名
```

**核心思想**: 在封闭集合（已知说话人库）中，如果第一名显著高于第二名，即使绝对分数不高，也可以认为是可信的。

### 3. 完全拒绝
```python
return None  # 分数太低或分差不明显
```

## 示例场景

### 场景 1: 高置信度识别 ✅
- Top-1: 0.66 (speaker_linyudong)
- Top-2: 0.30
- **判断**: 0.66 >= 0.60 → **直接识别成功**
- **结果**: speaker_linyudong

### 场景 2: 分差挽救成功 ✅
- Top-1: 0.50 (speaker_linyudong)
- Top-2: 0.25
- **判断**: 
  - 0.50 < 0.60 (不满足高置信度)
  - 0.50 >= 0.40 ✓ (满足最低分数)
  - 0.50 - 0.25 = 0.25 >= 0.15 ✓ (分差足够大)
- **结果**: speaker_linyudong（分差挽救）

### 场景 3: 分数太低被拒绝 ❌
- Top-1: 0.35
- Top-2: 0.15
- **判断**: 
  - 0.35 < 0.60 (不满足高置信度)
  - 0.35 < 0.40 ✗ (低于最低容忍分数)
- **结果**: 拒绝识别，保持 "Speaker X"

### 场景 4: 分差太小被拒绝 ❌
- Top-1: 0.50
- Top-2: 0.45
- **判断**: 
  - 0.50 < 0.60 (不满足高置信度)
  - 0.50 >= 0.40 ✓ (满足最低分数)
  - 0.50 - 0.45 = 0.05 < 0.15 ✗ (分差太小)
- **结果**: 拒绝识别，保持 "Speaker X"

### 场景 5: 你的案例（0.59 分）
- Top-1: 0.59 (speaker_xxx)
- Top-2: 0.30
- **判断**: 
  - 0.59 < 0.60 (不满足高置信度，差一点点)
  - 0.59 >= 0.40 ✓ (满足最低分数)
  - 0.59 - 0.30 = 0.29 >= 0.15 ✓ (分差足够大)
- **结果**: speaker_xxx（分差挽救）✅

## 阈值调优建议

### 提高召回率（识别更多人）

如果经常出现"应该识别但没识别"的情况：

1. **降低高置信度阈值**
   ```python
   self.score_threshold = 0.55  # 从 0.60 降到 0.55
   ```

2. **降低最低容忍分数**
   ```python
   self.min_accept_score = 0.35  # 从 0.40 降到 0.35
   ```

3. **降低分差阈值**
   ```python
   self.gap_threshold = 0.10  # 从 0.15 降到 0.10
   ```

**风险**: 可能增加误识别率

### 提高准确率（减少误识别）

如果经常出现"识别错误"的情况：

1. **提高高置信度阈值**
   ```python
   self.score_threshold = 0.65  # 从 0.60 提高到 0.65
   ```

2. **提高最低容忍分数**
   ```python
   self.min_accept_score = 0.45  # 从 0.40 提高到 0.45
   ```

3. **提高分差阈值**
   ```python
   self.gap_threshold = 0.20  # 从 0.15 提高到 0.20
   ```

**风险**: 可能降低召回率，更多人无法识别

## 讯飞官方推荐 vs 我们的配置

| 参数 | 讯飞推荐 | 我们的配置 | 说明 |
|------|---------|-----------|------|
| 高置信度阈值 | 0.60 | 0.60 | 一致 |
| 最低容忍分数 | 0.35 | 0.40 | 我们更保守 |
| 分差阈值 | 0.20 | 0.15 | 我们更宽松 |

## 调整历史

### 2026-01-14: 实现真正的分差挽救机制
- **原因**: 用户反馈 0.59 分数未能识别，且发现当前实现缺少真正的分差挽救
- **调整**: 
  - 高置信度阈值: 0.55 → **0.60**
  - 新增最低容忍分数: **0.40**
  - 分差阈值: 0.05 → **0.15**（改为"分差大于阈值"逻辑）
- **效果**: 
  - 实现三级判断机制
  - 即使分数低于 0.60，只要 >= 0.40 且分差 >= 0.15 也能识别
  - 0.59 分的案例现在可以通过分差挽救识别

### 之前: 简化的分差检查
- **问题**: 只检查分差是否太小，没有真正的挽救机制
- **逻辑**: 分数 >= 0.55 且分差 >= 0.05 才识别
- **缺陷**: 无法处理"分数不高但分差大"的情况

## 如何修改阈值

编辑文件: `src/providers/iflytek_voiceprint.py`

```python
class IFlyTekVoiceprint(VoiceprintProvider):
    def __init__(self, config: IFlyTekConfig):
        # ...
        
        # 识别阈值配置
        self.score_threshold = 0.60  # 高置信度阈值
        self.min_accept_score = 0.40  # 最低容忍分数
        self.gap_threshold = 0.15  # 分差挽救阈值
```

修改后需要：
1. 重启应用
2. 更新测试文件 `tests/unit/test_providers_voiceprint.py` 中的断言

## 监控建议

建议记录以下指标来评估阈值效果：

1. **高置信度识别率**: 直接通过 >= 0.60 识别的比例
2. **分差挽救识别率**: 通过分差挽救识别的比例
3. **拒绝率**: 因阈值拒绝识别的比例
4. **误识别率**: 识别错误的比例
5. **平均分数**: 成功识别的平均分数
6. **平均分差**: 成功识别的平均分差

根据这些指标调整阈值以达到最佳平衡。

## 提高识别分数的建议

除了调整阈值，还可以通过以下方式提高识别分数：

1. **使用更长的音频样本** (3-6秒最佳)
2. **使用更清晰的音频** (减少背景噪音)
3. **使用更多样本注册声纹** (多次注册同一个人)
4. **确保音频格式正确** (16kHz, 单声道, 16bit WAV)
5. **选择说话人连续说话的片段** (避免断断续续)

## 参考资料

- 讯飞声纹识别 API 文档
- `AI参考文件夹/2_声纹识别/iflytek_voiceprint.py` (参考实现)
- 参考实现的分差挽救机制（min_accept_score=0.35, gap_threshold=0.20）
