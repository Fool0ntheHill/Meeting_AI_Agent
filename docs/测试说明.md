# 测试说明

本文档说明如何测试会议纪要 Agent 系统。

## 测试类型

### 1. 单元测试 (已完成)

**覆盖范围**: 153 个测试,覆盖所有核心功能

```bash
# 运行所有单元测试
python -m pytest tests/unit/ -v

# 运行特定模块测试
python -m pytest tests/unit/test_services_pipeline.py -v

# 生成覆盖率报告
python -m pytest tests/unit/ --cov=src --cov-report=html
```

**测试分布**:
- 配置管理: 12 tests
- 核心模型: 12 tests
- ASR 提供商: 20 tests
- LLM 提供商: 18 tests
- 声纹识别: 21 tests
- 衍生内容生成: 16 tests
- 修正服务: 10 tests
- 管线编排: 10 tests
- 说话人识别: 10 tests
- 转写服务: 10 tests
- 工具模块: 14 tests

### 2. 端到端集成测试 (本文档)

**目的**: 测试完整的会议处理流程

**流程**:
1. 音频转写 (ASR)
2. 说话人识别 (可选)
3. ASR 修正
4. 生成会议纪要

## 快速开始

### 步骤 1: 检查配置

```bash
# 运行配置检查工具
python scripts/check_config.py

# 或指定配置文件
python scripts/check_config.py --config config/test.yaml
```

**预期输出**:
```
================================================================================
配置检查工具
================================================================================

[1/5] 检查配置文件: config/test.yaml
✓ 配置文件存在

[2/5] 加载配置...
✓ 配置加载成功

[3/5] 检查必需配置...

  火山引擎 ASR:
    ✓ access_key: xxxxxxxxxx...
    ✓ secret_key: xxxxxxxxxx...
    ✓ app_id: 1234567890
    ✓ cluster_id: volcengine_xxx
    ✓ tos_bucket: my-bucket

  Gemini LLM:
    ✓ api_keys: 1 个密钥
      - 密钥 1: AIzaSyXXXX...
    ✓ model: gemini-2.0-flash-exp
    ✓ max_tokens: 8192

[4/5] 检查可选配置...

  Azure ASR (可选):
    - 未配置(将无法使用 Azure 作为备用 ASR)

  科大讯飞声纹识别 (可选):
    - 未配置(将无法使用说话人识别)
    - 测试时请使用 --skip-speaker-recognition

[5/5] 配置检查总结:

  ✓ 火山引擎 ASR: 已配置
  ✓ Gemini LLM: 已配置

================================================================================
✓ 配置检查通过!
================================================================================

下一步:
  python scripts/test_e2e.py --audio test_data/meeting.wav
```

### 步骤 2: 运行端到端测试

```bash
# 基础测试(跳过说话人识别)
python scripts/test_e2e.py \
  --audio test_data/meeting.wav \
  --skip-speaker-recognition

# 完整测试(包含说话人识别)
python scripts/test_e2e.py \
  --audio test_data/meeting.wav

# 测试多文件拼接
python scripts/test_e2e.py \
  --audio part1.wav part2.wav part3.wav \
  --file-order 0 1 2
```

## 配置要求

### 必需配置

1. **火山引擎 ASR**
   - `access_key`: 访问密钥
   - `secret_key`: 密钥
   - `app_id`: 应用 ID
   - `cluster_id`: 集群 ID
   - `tos_bucket`: TOS 存储桶名称
   - `tos_region`: TOS 区域

2. **Gemini LLM**
   - `api_keys`: API 密钥列表(至少 1 个)
   - `model`: 模型名称(推荐 gemini-2.0-flash-exp)
   - `max_tokens`: 最大 Token 数
   - `temperature`: 温度参数

### 可选配置

3. **Azure ASR** (备用 ASR)
   - `subscription_keys`: 订阅密钥列表
   - `region`: 区域

4. **科大讯飞声纹识别** (说话人识别)
   - `app_id`: 应用 ID
   - `api_key`: API Key
   - `api_secret`: API Secret
   - `group_id`: 声纹库 ID

## 测试场景

### 场景 1: 最小化测试

**目的**: 验证核心功能(转写 + 生成纪要)

**配置**: 火山引擎 ASR + Gemini LLM

**命令**:
```bash
python scripts/test_e2e.py \
  --audio test_data/meeting.wav \
  --skip-speaker-recognition
```

**预期结果**:
- ✓ 音频转写成功
- ✓ 生成会议纪要
- ✓ 包含标题、摘要、关键要点、行动项

### 场景 2: 完整功能测试

**目的**: 验证所有功能(转写 + 说话人识别 + 生成纪要)

**配置**: 火山引擎 ASR + 科大讯飞声纹 + Gemini LLM

**命令**:
```bash
python scripts/test_e2e.py \
  --audio test_data/meeting.wav
```

**预期结果**:
- ✓ 音频转写成功
- ✓ 说话人识别成功
- ✓ 参与者列表包含真实姓名
- ✓ 生成会议纪要

### 场景 3: 多文件拼接测试

**目的**: 验证多段录音拼接功能

**配置**: 火山引擎 ASR + Gemini LLM

**命令**:
```bash
python scripts/test_e2e.py \
  --audio part1.wav part2.wav part3.wav \
  --file-order 0 1 2 \
  --skip-speaker-recognition
```

**预期结果**:
- ✓ 多个音频文件按顺序拼接
- ✓ 时间戳正确调整
- ✓ 生成完整会议纪要

### 场景 4: 双轨 ASR 降级测试

**目的**: 验证 ASR 降级机制

**配置**: 火山引擎 ASR + Azure ASR + Gemini LLM

**测试方法**:
1. 故意配置错误的火山引擎密钥
2. 配置正确的 Azure 密钥
3. 运行测试

**预期结果**:
- ✓ 火山引擎 ASR 失败
- ✓ 自动降级到 Azure ASR
- ✓ 最终处理成功

## 测试数据准备

### 音频文件要求

- **格式**: WAV, MP3, M4A 等常见格式
- **采样率**: 建议 16kHz(系统会自动转换)
- **声道**: 单声道或立体声(系统会自动转换为单声道)
- **时长**: 
  - 首次测试: 1-5 分钟
  - 完整测试: 5-30 分钟
  - 压力测试: 30-120 分钟
- **内容**: 包含多人对话的会议录音

### 创建测试音频

#### 方式 1: 使用手机录音

1. 打开手机录音应用
2. 录制一段简短对话(1-2 分钟)
3. 导出为 WAV 或 MP3 格式
4. 传输到测试目录

#### 方式 2: 使用 ffmpeg 转换

```bash
# 转换为标准格式
ffmpeg -i input.mp3 -ar 16000 -ac 1 output.wav

# 提取音频片段
ffmpeg -i input.wav -ss 00:00:00 -t 00:05:00 output.wav

# 拼接多个音频
ffmpeg -i "concat:part1.wav|part2.wav|part3.wav" -c copy output.wav
```

#### 方式 3: 使用示例音频

如果你有旧项目的测试音频,可以直接使用:

```bash
# 复制旧项目的测试音频
cp AI参考文件夹/test_audio/*.wav test_data/
```

## 故障排查

### 问题 1: 配置检查失败

**症状**: `check_config.py` 报告配置未通过

**解决**:
1. 检查配置文件是否存在
2. 确认 API 密钥已正确填写
3. 确认密钥没有多余的空格或引号

### 问题 2: 音频转写失败

**症状**: `ASRError: Transcription failed`

**可能原因**:
1. API 密钥无效
2. 音频格式不支持
3. 网络连接问题
4. API 配额用尽

**解决**:
1. 验证 API 密钥
2. 转换音频格式为 WAV
3. 检查网络连接
4. 检查 API 配额

### 问题 3: 说话人识别失败

**症状**: `VoiceprintError: Speaker recognition failed`

**可能原因**:
1. 科大讯飞 API 未配置
2. 声纹库未创建
3. 音频质量太差

**解决**:
1. 使用 `--skip-speaker-recognition` 跳过
2. 创建声纹库并注册样本
3. 使用更清晰的音频

### 问题 4: LLM 生成失败

**症状**: `LLMError: Generation failed`

**可能原因**:
1. Gemini API 密钥无效
2. Token 超限
3. 速率限制

**解决**:
1. 验证 API 密钥
2. 减少音频时长
3. 配置多个密钥轮换

### 问题 5: 响应解析失败

**症状**: `LLMResponseParseError: Invalid JSON`

**可能原因**:
1. LLM 返回格式不正确
2. 提示词模板问题

**解决**:
1. 查看原始响应内容
2. 调整提示词模板
3. 降低 temperature 参数

## 性能基准

### 预期处理时间

| 音频时长 | 转写时间 | 说话人识别 | 生成纪要 | 总时间 |
|---------|---------|-----------|---------|--------|
| 1 分钟  | ~10s    | ~5s       | ~5s     | ~20s   |
| 5 分钟  | ~30s    | ~10s      | ~10s    | ~50s   |
| 30 分钟 | ~2min   | ~30s      | ~20s    | ~3min  |
| 60 分钟 | ~4min   | ~1min     | ~30s    | ~6min  |

**注意**: 实际时间取决于网络状况和 API 响应速度

### 成本估算

| 服务 | 单价 | 1 分钟音频 | 30 分钟音频 |
|-----|------|-----------|------------|
| 火山引擎 ASR | ¥0.00005/秒 | ¥0.003 | ¥0.09 |
| 科大讯飞声纹 | ¥0.00003/秒 | ¥0.009 | ¥0.27 |
| Gemini LLM | ¥0.00002/Token | ¥0.02 | ¥0.60 |
| **总计** | - | **¥0.032** | **¥0.96** |

**注意**: 价格仅供参考,以实际 API 定价为准

## 下一步

测试成功后,你可以:

1. **继续开发**: 实现数据库层、API 层等功能
2. **优化配置**: 调整参数以获得更好的效果
3. **部署上线**: 参考部署文档进行生产环境部署
4. **集成前端**: 开发 Web 界面或移动应用

## 相关文档

- [快速开始指南](./快速开始.md)
- [测试配置指南](./测试配置指南.md)
- [设计文档](../.kiro/specs/meeting-minutes-agent/design.md)
- [任务列表](../.kiro/specs/meeting-minutes-agent/tasks.md)
