# GSUC SSO å¸¸è§é—®é¢˜è§£ç­”

## â“ ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜

### 1. ç›®å‰æœ‰ä»€ä¹ˆå®‰å…¨æ¼æ´ï¼Ÿ

#### ğŸ”´ ä¸¥é‡æ¼æ´ (å¿…é¡»ä¿®å¤)

| æ¼æ´ | main.py | auth.py | é£é™© | ä¿®å¤æ–¹æ¡ˆ |
|------|---------|---------|------|----------|
| **ç¼ºå°‘ State éªŒè¯** | âŒ æ—  | âš ï¸ ç®€åŒ– | CSRF æ”»å‡» | ä½¿ç”¨ Redis å­˜å‚¨å¹¶éªŒè¯ state |
| **SessionID ä¸å®‰å…¨** | âŒ å¯é¢„æµ‹ | âœ… JWT | ä¼šè¯åŠ«æŒ | ä½¿ç”¨ JWT Token |
| **å¯†é’¥ç¡¬ç¼–ç ** | âŒ ç¡¬ç¼–ç  | âœ… é…ç½® | å¯†é’¥æ³„éœ² | ä½¿ç”¨ç¯å¢ƒå˜é‡ |
| **æ²¡æœ‰ HTTPS å¼ºåˆ¶** | âŒ æ—  | âš ï¸ å»ºè®® | ä¸­é—´äººæ”»å‡» | ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ HTTPS |

#### ğŸŸ¡ ä¸­ç­‰é£é™© (å»ºè®®ä¿®å¤)

| æ¼æ´ | é£é™© | ä¿®å¤æ–¹æ¡ˆ |
|------|------|----------|
| **æ²¡æœ‰é€Ÿç‡é™åˆ¶** | æš´åŠ›æ”»å‡» | ä½¿ç”¨ slowapi é™åˆ¶è¯·æ±‚é¢‘ç‡ |
| **é”™è¯¯ä¿¡æ¯æ³„éœ²** | ä¿¡æ¯æ³„éœ² | ç”Ÿäº§ç¯å¢ƒéšè—è¯¦ç»†é”™è¯¯ |
| **æ²¡æœ‰æ—¥å¿—å®¡è®¡** | æ— æ³•è¿½è¸ª | è®°å½•ç™»å½•å¤±è´¥ã€å¼‚å¸¸è®¿é—® |

#### ğŸŸ¢ ä½é£é™© (å¯é€‰ä¼˜åŒ–)

- æ²¡æœ‰ Code é‡æ”¾ä¿æŠ¤ (ä¾èµ– GSUC æœåŠ¡ç«¯)
- æ²¡æœ‰ç”¨æˆ·ä¼šè¯ç®¡ç†
- æ²¡æœ‰å¤šå› ç´ è®¤è¯ (MFA)

---

### 2. main.py å’Œ auth.py æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

#### æ ¸å¿ƒå·®å¼‚å¯¹æ¯”

| ç»´åº¦ | main.py | auth.py |
|------|---------|---------|
| **å®šä½** | ç‹¬ç«‹æ¼”ç¤ºåº”ç”¨ | ç”Ÿäº§çº§é›†æˆæ–¹æ¡ˆ |
| **ä»£ç é‡** | ~200 è¡Œ | ~400 è¡Œ |
| **ä¾èµ–** | æœ€å°åŒ– (fastapi, httpx, pycryptodome) | å®Œæ•´æ¡†æ¶ (æ•°æ®åº“, Redis, JWT) |
| **Token ç±»å‹** | âŒ SessionID (`session_zhangsan_1003`) | âœ… JWT Token (æœ‰ç­¾åã€è¿‡æœŸæ—¶é—´) |
| **State éªŒè¯** | âŒ æ—  | âš ï¸ æ¥æ”¶ä½†æœªå®Œå…¨éªŒè¯ |
| **å¯†é’¥ç®¡ç†** | âŒ ç¡¬ç¼–ç  | âœ… ä»é…ç½®æ–‡ä»¶è¯»å– |
| **ç”¨æˆ·ç®¡ç†** | âŒ æ— æ•°æ®åº“ | âœ… å®Œæ•´çš„ç”¨æˆ·è¡¨ |
| **ä¼šè¯ç®¡ç†** | âŒ æ—  | âœ… å¯ä»¥ç®¡ç†ä¼šè¯ |
| **é”™è¯¯å¤„ç†** | âš ï¸ è¯¦ç»†æ—¥å¿— | âœ… ç»“æ„åŒ–æ—¥å¿— |
| **é€‚ç”¨åœºæ™¯** | å­¦ä¹ ã€æµ‹è¯•ã€æ¼”ç¤º | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² |

#### æµç¨‹å¯¹æ¯”

**main.py æµç¨‹ (ç®€åŒ–):**
```
1. æ¥æ”¶ code
2. ç”Ÿæˆ access_token (åŠ å¯†)
3. è¯·æ±‚ GSUC ç”¨æˆ·ä¿¡æ¯
4. ç”Ÿæˆ SessionID: session_{account}_{uid}
5. é‡å®šå‘åˆ°å‰ç«¯
```

**auth.py æµç¨‹ (å®Œæ•´):**
```
1. å‰ç«¯è¯·æ±‚ç™»å½• URL
2. åç«¯ç”Ÿæˆ GSUC URL + state
3. å‰ç«¯é‡å®šå‘ç”¨æˆ·åˆ° GSUC
4. ç”¨æˆ·æ‰«ç ç™»å½•
5. GSUC å›è°ƒåç«¯ (æºå¸¦ code + state)
6. åç«¯éªŒè¯ state
7. åç«¯ä½¿ç”¨ Provider è·å–ç”¨æˆ·ä¿¡æ¯
8. åç«¯æŸ¥æ‰¾æˆ–åˆ›å»ºç”¨æˆ· (æ•°æ®åº“)
9. åç«¯ç”Ÿæˆ JWT Token
10. åç«¯é‡å®šå‘åˆ°å‰ç«¯ (æºå¸¦ token + ç”¨æˆ·ä¿¡æ¯)
```

#### åŠ å¯†ç®—æ³•å¯¹æ¯”

**å®Œå…¨ç›¸åŒ!** ä¸¤è€…éƒ½ä½¿ç”¨ç›¸åŒçš„åŠ å¯†ç®—æ³•:
- Python 2 -> Python 3 è¿ç§»
- AES-256-CBC åŠ å¯†
- Base64 ç¼–ç 
- 16 ä½éšæœºå‰ç¼€
- 32 å­—èŠ‚å¯¹é½

---

### 3. ç™»å½•ä¿¡æ¯é”™è¯¯åº”è¯¥è¿”å› 401 å—ï¼Ÿ

#### âœ… æ ‡å‡†ç­”æ¡ˆ: çœ‹å…·ä½“æƒ…å†µ

æ ¹æ® RFC 7235 å’Œ OAuth2.0 è§„èŒƒ:

| é”™è¯¯åœºæ™¯ | æ­£ç¡®çŠ¶æ€ç  | è¯´æ˜ |
|---------|-----------|------|
| **Code æ— æ•ˆ/è¿‡æœŸ** | `401 Unauthorized` | âœ… è®¤è¯å¤±è´¥ |
| **State æ— æ•ˆ** | `400 Bad Request` | âœ… å‚æ•°é”™è¯¯ (ä¸æ˜¯è®¤è¯é—®é¢˜) |
| **GSUC API å¤±è´¥** | `502 Bad Gateway` | âœ… ä¸Šæ¸¸æœåŠ¡é”™è¯¯ |
| **åŠ å¯†å¤±è´¥** | `500 Internal Server Error` | âœ… æœåŠ¡å™¨é…ç½®é”™è¯¯ |
| **ç”¨æˆ·è¢«ç¦ç”¨** | `403 Forbidden` | âœ… æœ‰èº«ä»½ä½†æ— æƒé™ |
| **ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´** | `502 Bad Gateway` | âœ… GSUC è¿”å›å¼‚å¸¸ |

#### è¯¦ç»†è¯´æ˜

**401 Unauthorized (è®¤è¯å¤±è´¥)**
- ç”¨äº: ç”¨æˆ·èº«ä»½éªŒè¯å¤±è´¥
- åœºæ™¯:
  - Code æ— æ•ˆæˆ–è¿‡æœŸ
  - Token æ— æ•ˆæˆ–è¿‡æœŸ
  - ç”¨æˆ·åå¯†ç é”™è¯¯
- ç¤ºä¾‹:
  ```python
  if data.get("rc") != 0:
      raise HTTPException(status_code=401, detail="Authentication failed")
  ```

**400 Bad Request (å‚æ•°é”™è¯¯)**
- ç”¨äº: è¯·æ±‚å‚æ•°é”™è¯¯
- åœºæ™¯:
  - ç¼ºå°‘å¿…éœ€å‚æ•°
  - State å‚æ•°æ— æ•ˆ
  - å‚æ•°æ ¼å¼é”™è¯¯
- ç¤ºä¾‹:
  ```python
  if not state or not verify_state(state):
      raise HTTPException(status_code=400, detail="Invalid state")
  ```

**403 Forbidden (æ— æƒé™)**
- ç”¨äº: æœ‰èº«ä»½ä½†æ— æƒé™
- åœºæ™¯:
  - ç”¨æˆ·è¢«ç¦ç”¨
  - åŠŸèƒ½æœªå¯ç”¨
  - æ— è®¿é—®æƒé™
- ç¤ºä¾‹:
  ```python
  if not user.is_active:
      raise HTTPException(status_code=403, detail="User disabled")
  ```

**500 Internal Server Error (æœåŠ¡å™¨é”™è¯¯)**
- ç”¨äº: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
- åœºæ™¯:
  - åŠ å¯†é…ç½®é”™è¯¯
  - æ•°æ®åº“è¿æ¥å¤±è´¥
  - æœªé¢„æœŸçš„å¼‚å¸¸
- ç¤ºä¾‹:
  ```python
  if not access_token:
      raise HTTPException(status_code=500, detail="Encryption error")
  ```

**502 Bad Gateway (ä¸Šæ¸¸æœåŠ¡é”™è¯¯)**
- ç”¨äº: ä¸Šæ¸¸æœåŠ¡é”™è¯¯
- åœºæ™¯:
  - GSUC API è¯·æ±‚å¤±è´¥
  - GSUC è¿”å›æ•°æ®å¼‚å¸¸
  - ç¬¬ä¸‰æ–¹æœåŠ¡ä¸å¯ç”¨
- ç¤ºä¾‹:
  ```python
  except httpx.HTTPError:
      raise HTTPException(status_code=502, detail="GSUC unavailable")
  ```

#### å½“å‰å®ç°å¯¹æ¯”

**main.py å½“å‰å®ç°:**
```python
# âœ… æ­£ç¡®
if rc != 0:
    raise HTTPException(status_code=401, detail="è®¤è¯å¤±è´¥")

# âš ï¸ åº”è¯¥ç”¨ 502
except httpx.HTTPError:
    raise HTTPException(status_code=500, detail="GSUC API å¤±è´¥")

# âš ï¸ åº”è¯¥ç”¨ 502
if not uid or not account:
    raise HTTPException(status_code=500, detail="ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´")
```

**auth.py å½“å‰å®ç°:**
```python
# âœ… æ­£ç¡®
if not config.gsuc.enabled:
    raise HTTPException(status_code=403, detail="GSUC æœªå¯ç”¨")

# âœ… æ­£ç¡®
if not state:
    raise HTTPException(status_code=400, detail="ç¼ºå°‘ state")

# âœ… æ­£ç¡®
except GSUCAuthError:
    raise HTTPException(status_code=401, detail="è®¤è¯å¤±è´¥")
```

**main_secure.py (å®‰å…¨åŠ å›ºç‰ˆæœ¬):**
```python
# âœ… å…¨éƒ¨æ­£ç¡®
if not verify_state(state):
    raise HTTPException(status_code=400, detail="Invalid state")

if not access_token:
    raise HTTPException(status_code=500, detail="Encryption error")

except httpx.HTTPError:
    raise HTTPException(status_code=502, detail="GSUC unavailable")

if rc != 0:
    raise HTTPException(status_code=401, detail="Authentication failed")

if not uid or not account:
    raise HTTPException(status_code=502, detail="Invalid GSUC response")
```

---

## ğŸ›¡ï¸ å®‰å…¨åŠ å›ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä½¿ç”¨ main_secure.py (æ¨è)

**ç‰¹ç‚¹:**
- âœ… ä¿®å¤äº†æ‰€æœ‰ä¸¥é‡æ¼æ´
- âœ… ä¿æŒç®€å•æ˜“æ‡‚
- âœ… æ— éœ€æ•°æ®åº“
- âœ… é€‚åˆå¿«é€Ÿéƒ¨ç½²

**ä½¿ç”¨æ–¹å¼:**
```bash
# 1. è®¾ç½®ç¯å¢ƒå˜é‡
export GSUC_APP_SECRET="your-secret-here"
export JWT_SECRET_KEY="your-jwt-secret-here"
export ENVIRONMENT="production"

# 2. å¯åŠ¨æœåŠ¡
uvicorn main_secure:app --host 0.0.0.0 --port 8000
```

### æ–¹æ¡ˆ 2: ä½¿ç”¨ auth.py + æ”¹è¿›

**ç‰¹ç‚¹:**
- âœ… ç”Ÿäº§çº§å®Œæ•´æ–¹æ¡ˆ
- âœ… å®Œæ•´çš„ç”¨æˆ·ç®¡ç†
- âœ… æ•°æ®åº“é›†æˆ
- âš ï¸ éœ€è¦æ·»åŠ  State éªŒè¯

**æ”¹è¿›å»ºè®®:**
```python
# åœ¨ auth.py ä¸­æ·»åŠ  State éªŒè¯
import redis
r = redis.Redis()

# ç”Ÿæˆç™»å½• URL æ—¶
state = secrets.token_urlsafe(32)
r.setex(f"gsuc_state:{state}", 300, "1")

# å›è°ƒæ—¶éªŒè¯
if not r.exists(f"gsuc_state:{state}"):
    raise HTTPException(status_code=400, detail="Invalid state")
r.delete(f"gsuc_state:{state}")
```

### æ–¹æ¡ˆ 3: æ··åˆæ–¹æ¡ˆ

**ä½¿ç”¨ auth.py çš„æ¶æ„ + main_secure.py çš„å®‰å…¨ç‰¹æ€§**

---

## ğŸ“Š ä¸‰ä¸ªç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | main.py | main_secure.py | auth.py |
|------|---------|----------------|---------|
| **State éªŒè¯** | âŒ | âœ… | âš ï¸ |
| **JWT Token** | âŒ | âœ… | âœ… |
| **ç¯å¢ƒå˜é‡** | âŒ | âœ… | âœ… |
| **é€Ÿç‡é™åˆ¶** | âŒ | âœ… | âŒ |
| **HTTPS å¼ºåˆ¶** | âŒ | âœ… | âš ï¸ |
| **æ­£ç¡®çŠ¶æ€ç ** | âš ï¸ | âœ… | âœ… |
| **ç”¨æˆ·ç®¡ç†** | âŒ | âŒ | âœ… |
| **æ•°æ®åº“é›†æˆ** | âŒ | âŒ | âœ… |
| **å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ | å¤æ‚ |
| **é€‚ç”¨åœºæ™¯** | å­¦ä¹  | ç”Ÿäº§ | ä¼ä¸š |

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### é€‰æ‹© main.py å½“:
- âœ… å­¦ä¹  SSO åŸç†
- âœ… å¿«é€Ÿæ¼”ç¤º
- âœ… ç†è§£åŠ å¯†ç®—æ³•
- âŒ ä¸è¦ç”¨äºç”Ÿäº§ç¯å¢ƒ

### é€‰æ‹© main_secure.py å½“:
- âœ… éœ€è¦å¿«é€Ÿéƒ¨ç½²
- âœ… ä¸éœ€è¦æ•°æ®åº“
- âœ… å®‰å…¨æ€§è¦æ±‚é«˜
- âœ… ç‹¬ç«‹çš„è®¤è¯æœåŠ¡

### é€‰æ‹© auth.py å½“:
- âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- âœ… éœ€è¦ç”¨æˆ·ç®¡ç†
- âœ… éœ€è¦æ•°æ®åº“é›†æˆ
- âœ… ä¼ä¸šçº§åº”ç”¨

---

## ğŸ” å¿«é€Ÿæ£€æŸ¥æ¸…å•

### å®‰å…¨æ£€æŸ¥

- [ ] State éªŒè¯å·²å®ç°
- [ ] ä½¿ç”¨ JWT Token (ä¸æ˜¯ç®€å• SessionID)
- [ ] å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡
- [ ] ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ HTTPS
- [ ] æ·»åŠ äº†é€Ÿç‡é™åˆ¶
- [ ] é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿæ•°æ®
- [ ] æœ‰å®‰å…¨å®¡è®¡æ—¥å¿—

### çŠ¶æ€ç æ£€æŸ¥

- [ ] Code æ— æ•ˆè¿”å› 401
- [ ] State æ— æ•ˆè¿”å› 400
- [ ] GSUC API å¤±è´¥è¿”å› 502
- [ ] åŠ å¯†å¤±è´¥è¿”å› 500
- [ ] ç”¨æˆ·è¢«ç¦ç”¨è¿”å› 403

### åŠŸèƒ½æ£€æŸ¥

- [ ] åŠ å¯†ç®—æ³•æ­£ç¡®
- [ ] å¯ä»¥è·å–ç”¨æˆ·ä¿¡æ¯
- [ ] Token å¯ä»¥éªŒè¯
- [ ] å‰ç«¯å¯ä»¥æ¥æ”¶ Token
- [ ] æ—¥å¿—è®°å½•å®Œæ•´

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å®‰å…¨åˆ†æè¯¦ç»†æ–‡æ¡£](./GSUC_SSO_SECURITY_ANALYSIS.md)
- [main.py å®ç°æ–‡æ¡£](./MAIN_SSO_IMPLEMENTATION.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](./MAIN_SSO_QUICK_START.md)
- [ç»¼åˆè¯´æ˜æ–‡æ¡£](../README_GSUC_SSO.md)

---

## ğŸ’¡ æ€»ç»“

1. **å®‰å…¨æ¼æ´**: main.py æœ‰å¤šä¸ªä¸¥é‡æ¼æ´ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
2. **å®ç°å·®å¼‚**: main.py ç®€å•ä½†ä¸å®‰å…¨ï¼Œauth.py å®Œæ•´ä½†å¤æ‚
3. **çŠ¶æ€ç **: æ ¹æ®å…·ä½“é”™è¯¯åœºæ™¯ä½¿ç”¨æ­£ç¡®çš„ HTTP çŠ¶æ€ç 
4. **æ¨èæ–¹æ¡ˆ**: 
   - å­¦ä¹ : main.py
   - å¿«é€Ÿéƒ¨ç½²: main_secure.py
   - ç”Ÿäº§ç¯å¢ƒ: auth.py (åŠ ä¸Š State éªŒè¯)
