# 端到端测试配置指南

本文档说明如何配置和运行端到端集成测试。

## 目录

- [前置要求](#前置要求)
- [配置步骤](#配置步骤)
- [API 密钥获取](#api-密钥获取)
- [运行测试](#运行测试)
- [故障排查](#故障排查)

## 前置要求

### 1. Python 环境

```bash
# Python 3.11+
python --version

# 安装依赖
pip install -r requirements.txt
```

### 2. 准备测试音频

准备一个或多个音频文件用于测试:
- 格式: WAV, MP3, M4A 等常见格式
- 时长: 建议 1-5 分钟(首次测试)
- 内容: 包含多人对话的会议录音

示例音频文件位置:
```
test_data/
  ├── meeting_sample.wav
  ├── meeting_part1.wav
  └── meeting_part2.wav
```

## 配置步骤

### 步骤 1: 创建配置文件

复制配置模板:

```bash
cp config/development.yaml.example config/development.yaml
```

### 步骤 2: 填写 API 密钥

编辑 `config/development.yaml`,填入以下 API 密钥:

#### 2.1 火山引擎 ASR (必需)

```yaml
volcano:
  access_key: YOUR_VOLCANO_ACCESS_KEY
  secret_key: YOUR_VOLCANO_SECRET_KEY
  app_id: YOUR_VOLCANO_APP_ID
  cluster_id: YOUR_VOLCANO_CLUSTER_ID
  tos_bucket: YOUR_TOS_BUCKET_NAME
  tos_region: cn-beijing
```

**获取方式**: 见 [火山引擎 API 密钥获取](#火山引擎-asr)

#### 2.2 Azure ASR (可选,作为备用)

```yaml
azure:
  subscription_keys:
    - YOUR_AZURE_KEY_1
    - YOUR_AZURE_KEY_2  # 可选,用于密钥轮换
  region: eastus
```

**获取方式**: 见 [Azure API 密钥获取](#azure-asr)

#### 2.3 科大讯飞声纹识别 (可选)

```yaml
iflytek:
  app_id: YOUR_IFLYTEK_APP_ID
  api_key: YOUR_IFLYTEK_API_KEY
  api_secret: YOUR_IFLYTEK_API_SECRET
  group_id: YOUR_IFLYTEK_GROUP_ID
```

**获取方式**: 见 [科大讯飞 API 密钥获取](#科大讯飞声纹识别)

**注意**: 如果不配置,可以使用 `--skip-speaker-recognition` 跳过说话人识别

#### 2.4 Gemini LLM (必需)

```yaml
gemini:
  api_keys:
    - YOUR_GEMINI_API_KEY_1
    - YOUR_GEMINI_API_KEY_2  # 可选,用于密钥轮换
  model: gemini-2.0-flash-exp
  max_tokens: 8192
  temperature: 0.7
```

**获取方式**: 见 [Gemini API 密钥获取](#gemini-llm)

### 步骤 3: 配置存储 (可选)

如果需要测试音频上传到 TOS:

```yaml
storage:
  provider: tos
  bucket: YOUR_STORAGE_BUCKET
  region: cn-beijing
  access_key: YOUR_STORAGE_ACCESS_KEY
  secret_key: YOUR_STORAGE_SECRET_KEY
```

**简化测试**: 可以暂时跳过此配置,使用本地文件路径

### 步骤 4: 简化配置(最小化测试)

如果只想快速测试核心功能,最小配置如下:

```yaml
# 最小配置示例
env: development
debug: true

# 火山引擎 ASR (必需)
volcano:
  access_key: YOUR_VOLCANO_ACCESS_KEY
  secret_key: YOUR_VOLCANO_SECRET_KEY
  app_id: YOUR_VOLCANO_APP_ID
  cluster_id: YOUR_VOLCANO_CLUSTER_ID
  tos_bucket: YOUR_TOS_BUCKET_NAME
  tos_region: cn-beijing

# Gemini LLM (必需)
gemini:
  api_keys:
    - YOUR_GEMINI_API_KEY
  model: gemini-2.0-flash-exp
  max_tokens: 8192
  temperature: 0.7

# 其他配置使用默认值
log:
  level: INFO
  format: json
```

## API 密钥获取

### 火山引擎 ASR

1. 访问 [火山引擎控制台](https://console.volcengine.com/)
2. 开通 **语音技术 - 语音识别** 服务
3. 创建应用,获取:
   - `app_id`: 应用 ID
   - `access_key`: 访问密钥
   - `secret_key`: 密钥
   - `cluster_id`: 集群 ID
4. 开通 **对象存储 TOS** 服务
5. 创建存储桶,获取:
   - `tos_bucket`: 存储桶名称
   - `tos_region`: 区域(如 cn-beijing)

**参考文档**: `api docs/火山API文档.txt`

### Azure ASR

1. 访问 [Azure Portal](https://portal.azure.com/)
2. 创建 **语音服务** 资源
3. 在资源页面获取:
   - `subscription_key`: 订阅密钥(密钥 1 或密钥 2)
   - `region`: 区域(如 eastus)

**参考文档**: `api docs/azure api文档.txt`

**注意**: 
- East Asia 区域不支持说话人分离(diarization)
- 建议使用 East US 区域

### 科大讯飞声纹识别

1. 访问 [讯飞开放平台](https://www.xfyun.cn/)
2. 创建应用,开通 **声纹识别** 服务
3. 获取:
   - `app_id`: 应用 ID
   - `api_key`: API Key
   - `api_secret`: API Secret
4. 创建声纹库,获取:
   - `group_id`: 声纹库 ID

**参考文档**: `api docs/讯飞声纹识别api.txt`

**注意**: 
- 需要先注册声纹样本才能使用 1:N 检索
- 测试时可以使用 `--skip-speaker-recognition` 跳过

### Gemini LLM

1. 访问 [Google AI Studio](https://aistudio.google.com/)
2. 点击 **Get API Key**
3. 创建或选择项目
4. 生成 API 密钥

**参考文档**: `api docs/gemini/`

**注意**:
- 免费配额有限,建议配置多个密钥轮换
- 推荐使用 `gemini-2.0-flash-exp` 模型(速度快、成本低)

## 运行测试

### 基础测试

测试单个音频文件:

```bash
python scripts/test_e2e.py --audio test_data/meeting_sample.wav
```

### 跳过说话人识别

如果没有配置科大讯飞 API:

```bash
python scripts/test_e2e.py \
  --audio test_data/meeting_sample.wav \
  --skip-speaker-recognition
```

### 测试多文件拼接

测试多个音频文件按顺序拼接:

```bash
python scripts/test_e2e.py \
  --audio test_data/meeting_part1.wav test_data/meeting_part2.wav \
  --file-order 0 1
```

### 指定会议描述

添加会议上下文信息:

```bash
python scripts/test_e2e.py \
  --audio test_data/meeting_sample.wav \
  --description "产品规划会议 - 讨论 Q2 路线图"
```

### 使用自定义配置

指定配置文件:

```bash
python scripts/test_e2e.py \
  --audio test_data/meeting_sample.wav \
  --config config/test.yaml
```

## 测试输出

成功运行后,你会看到类似以下输出:

```
================================================================================
开始端到端集成测试
================================================================================

[1/7] 初始化服务...
✓ 服务初始化完成

[2/7] 准备测试数据...
✓ 任务 ID: test_task_1234567890.123
✓ 音频文件: ['test_data/meeting_sample.wav']
✓ 文件排序: [0]
✓ 跳过说话人识别: False

[3/7] 开始管线处理...
Task test_task_1234567890.123: Starting transcription phase
Task test_task_1234567890.123: Transcription completed, duration=120.5s, segments=45
Task test_task_1234567890.123: Starting speaker recognition phase
Task test_task_1234567890.123: Speaker recognition completed, speakers=3
Task test_task_1234567890.123: Starting correction phase
Task test_task_1234567890.123: Correction completed
Task test_task_1234567890.123: Starting artifact generation phase
Task test_task_1234567890.123: Artifact generation completed, artifact_id=art_..., version=1
Task test_task_1234567890.123: Pipeline completed successfully
✓ 管线处理完成

[4/7] 处理结果:
  - Artifact ID: art_test_task_1234567890.123_meeting_minutes_v1
  - 任务 ID: test_task_1234567890.123
  - 内容类型: meeting_minutes
  - 版本: 1
  - 创建者: test_user
  - 创建时间: 2026-01-14 10:30:45.123456

[5/7] 会议纪要内容:
{
  "title": "产品规划会议",
  "participants": ["张三", "李四", "王五"],
  "summary": "本次会议讨论了 Q2 产品路线图...",
  "key_points": [
    "确定了三个核心功能优先级",
    "讨论了用户反馈的主要问题",
    "制定了下一步行动计划"
  ],
  "action_items": [
    "张三负责完成需求文档",
    "李四安排技术评审会议",
    "王五跟进用户调研"
  ]
}
✓ 所有必需字段都存在

[6/7] 统计信息:
  - 会议标题: 产品规划会议
  - 参与者数量: 3
  - 参与者: 张三, 李四, 王五
  - 关键要点数量: 3
  - 行动项数量: 3

[7/7] 测试完成!
================================================================================
✓ 端到端集成测试成功
================================================================================
```

## 故障排查

### 问题 1: 配置文件加载失败

**错误信息**:
```
✗ 配置加载失败: [Errno 2] No such file or directory: 'config/development.yaml'
```

**解决方法**:
```bash
# 确保配置文件存在
ls -la config/development.yaml

# 如果不存在,复制模板
cp config/development.yaml.example config/development.yaml
```

### 问题 2: API 密钥无效

**错误信息**:
```
✗ 管线处理失败: Authentication failed
```

**解决方法**:
1. 检查配置文件中的 API 密钥是否正确
2. 确认 API 密钥没有过期
3. 检查 API 服务是否已开通

### 问题 3: 音频文件格式不支持

**错误信息**:
```
✗ 音频处理失败: Unsupported audio format
```

**解决方法**:
1. 确保音频文件格式为 WAV, MP3, M4A 等常见格式
2. 使用 ffmpeg 转换音频格式:
   ```bash
   ffmpeg -i input.mp3 -ar 16000 -ac 1 output.wav
   ```

### 问题 4: 网络连接超时

**错误信息**:
```
✗ 管线处理失败: Connection timeout
```

**解决方法**:
1. 检查网络连接
2. 确认防火墙没有阻止 API 请求
3. 增加配置文件中的 `timeout` 值

### 问题 5: 配额超限

**错误信息**:
```
✗ 管线处理失败: Rate limit exceeded
```

**解决方法**:
1. 等待配额重置(通常每天或每月)
2. 配置多个 API 密钥进行轮换
3. 升级 API 服务套餐

### 问题 6: Gemini 响应解析失败

**错误信息**:
```
✗ 解析内容失败: Invalid JSON response
```

**解决方法**:
1. 检查 Gemini 返回的原始内容
2. 调整提示词模板,明确要求返回 JSON 格式
3. 增加 `temperature` 参数以获得更稳定的输出

## 环境变量配置(可选)

除了配置文件,也可以使用环境变量:

```bash
# 设置环境变量
export VOLCANO_ACCESS_KEY="your_access_key"
export VOLCANO_SECRET_KEY="your_secret_key"
export VOLCANO_APP_ID="your_app_id"
export GEMINI_API_KEY_1="your_gemini_key"

# 运行测试
python scripts/test_e2e.py --audio test_data/meeting_sample.wav
```

配置文件中使用 `${ENV_VAR}` 语法引用环境变量:

```yaml
volcano:
  access_key: ${VOLCANO_ACCESS_KEY}
  secret_key: ${VOLCANO_SECRET_KEY}
```

## 下一步

测试成功后,你可以:

1. **查看代码**: 了解各个服务的实现细节
2. **调整配置**: 优化参数以获得更好的效果
3. **继续开发**: 实现数据库层、API 层等功能
4. **部署上线**: 参考部署文档进行生产环境部署

## 相关文档

- [需求文档](../.kiro/specs/meeting-minutes-agent/requirements.md)
- [设计文档](../.kiro/specs/meeting-minutes-agent/design.md)
- [任务列表](../.kiro/specs/meeting-minutes-agent/tasks.md)
- [API 文档](../api docs/)

## 技术支持

如有问题,请查看:
- 项目 README.md
- 设计文档中的故障排查章节
- API 提供商的官方文档
