# 需求文档

## 简介

本文档规定了将会议纪要 Agent 从零散的测试脚本重构为生产级面向对象系统的需求。该系统通过 ASR(自动语音识别)、声纹识别和 LLM 摘要处理会议录音,生成带有说话人身份的结构化会议纪要。

## 文档说明

本需求文档遵循以下原则:

1. **能力承诺**: 描述系统承诺的能力和用户可感知的行为,不涉及具体实现技术(如 SDK、参数名、队列实现)
2. **稳定性前提**: 凡是影响系统稳定性和用户体验的能力边界,必须在需求中明确
3. **实现分离**: 纯工程实现细节(如缓存策略、信号处理)不在需求中描述,但其产生的效果(如可靠性、一致性)需要体现

## 术语表

- **系统(System)**: 会议纪要 Agent 应用程序
- **ASR提供商(ASR_Provider)**: 自动语音识别服务提供商(火山引擎或 Azure)
- **声纹提供商(Voiceprint_Provider)**: 说话人识别服务提供商(科大讯飞)
- **LLM提供商(LLM_Provider)**: 大语言模型服务提供商(Gemini)
- **管线(Pipeline)**: 通过 ASR、声纹和 LLM 阶段处理音频的编排工作流
- **步骤(Step)**: Pipeline 中的单个处理阶段
- **TOS**: 火山引擎使用的对象存储服务
- **片段(Segment)**: 带有时间戳、说话人标签和文本内容的语句
- **转写结果(Transcript)**: 代表完整会议对话的片段集合
- **热词(Hot_Word)**: 用于提高 ASR 准确性的自定义词汇
- **说话人样本(Speaker_Sample)**: 为声纹识别提取的音频片段
- **分差挽救(Gap_Rescue)**: 在低置信度场景下改善声纹匹配的机制
- **降级(Fallback)**: 失败时从主服务自动切换到备用服务
- **消息队列(Message_Queue)**: 用于任务分发的中间件(Redis 或 RabbitMQ)
- **Worker**: 从队列拉取任务并执行处理的后台进程
- **Producer**: 创建任务并推送到队列的组件(Web API)
- **Consumer**: 从队列消费任务并执行的组件(Worker)
- **任务状态(Task_State)**: 任务在生命周期中的当前阶段
- **幂等性(Idempotency)**: 多次执行相同操作产生相同结果的特性
- **熔断(Circuit_Breaker)**: 在连续失败时自动停止调用的保护机制
- **配额(Quota)**: API 密钥的使用限制(调用次数、Token 数等)
- **提示词模板(Prompt_Template)**: 用于控制生成内容风格与目标的可复用模板,包含模板 ID、标题、说明、提示词正文(含占位符)、支持的语言和参数定义
- **提示词实例(Prompt_Instance)**: 基于模板创建的具体 Prompt,绑定特定的模板 ID、语言和参数值
- **会议衍生内容(Generated_Artifacts)**: 从会议转写生成的各类内容的集合,每个会议可以有多个衍生内容,每个衍生内容有类型(纪要/笔记/行动项等)和版本
- **衍生内容类型(Artifact_Type)**: 生成内容的类型,如 meeting_minutes(会议纪要)、action_items(行动项)、summary_notes(摘要笔记)等

## 需求

### 需求 1: ASR 提供商抽象

**用户故事:** 作为开发者,我希望有统一的 ASR 提供商接口,以便在不改变业务逻辑的情况下轻松切换不同的 ASR 服务。

#### 验收标准

1. 系统应当定义抽象的 ASR_Provider 接口,包含 transcribe、validate_config 和 get_supported_formats 方法
2. 当实现新的 ASR 提供商时,系统应当只需要实现 ASR_Provider 接口
3. ASR_Provider 接口应当返回标准化的 TranscriptionResult 对象,无论底层提供商是什么
4. 当 ASR 提供商被实例化时,系统应当在允许转写之前验证其配置

### 需求 2: 火山引擎 ASR 实现

**用户故事:** 作为系统操作员,我希望使用火山引擎作为主要的 ASR 提供商,以便利用其高时间戳精度和热词支持。

#### 验收标准

1. Volcano_ASR_Provider 应当实现 ASR_Provider 接口
2. 当转写音频时,Volcano_ASR_Provider 应当将音频文件上传到 TOS 存储
3. 当提交转写任务时,Volcano_ASR_Provider 应当支持自定义热词列表
4. 当轮询结果时,Volcano_ASR_Provider 应当实现指数退避和最大重试限制
5. Volcano_ASR_Provider 应当将 API 响应解析为带有时间戳、说话人标签和文本的标准化 Segment 对象
6. 当 API 响应包含敏感词屏蔽时,Volcano_ASR_Provider 应当抛出特定异常以进行降级处理
7. 系统应当默认支持中英文混合会议转写,转写阶段以准确识别会议内容为目标

### 需求 3: Azure ASR 实现

**用户故事:** 作为系统操作员,我希望 Azure ASR 作为备用提供商,以便在火山引擎失败或屏蔽内容时系统仍能运行。

#### 验收标准

1. Azure_ASR_Provider 应当实现 ASR_Provider 接口
2. 当音频文件超过大小限制时,Azure_ASR_Provider 应当自动将其拆分为可处理的块
3. Azure_ASR_Provider 应当使用 East US 区域端点以支持说话人分离
4. 当转写音频时,Azure_ASR_Provider 应当启用说话人分离功能
5. Azure_ASR_Provider 应当将 API 响应解析为与火山格式匹配的标准化 Segment 对象

### 需求 4: ASR 降级策略

**用户故事:** 作为系统操作员,我希望从火山自动降级到 Azure,以便即使主提供商失败转写也能成功。

#### 验收标准

1. 当 Volcano_ASR_Provider 抛出敏感词屏蔽异常时,系统应当自动使用 Azure_ASR_Provider 重试
2. 当 Volcano_ASR_Provider 抛出网络或 API 错误时,系统应当自动使用 Azure_ASR_Provider 重试
3. 当两个 ASR 提供商都失败时,系统应当抛出包含两次尝试详情的综合错误
4. 系统应当记录所有降级事件,包括提供商名称和失败原因

### 需求 5: 声纹提供商抽象

**用户故事:** 作为开发者,我希望有统一的声纹提供商接口,以便将来可能支持多个声纹服务。

#### 验收标准

1. 系统应当定义抽象的 Voiceprint_Provider 接口,包含 identify 和 register 方法
2. Voiceprint_Provider 接口应当接受音频字节并返回 SpeakerIdentity 对象
3. 当识别失败或置信度低于阈值时,Voiceprint_Provider 应当返回 None
4. Voiceprint_Provider 接口应当支持可配置的置信度阈值

### 需求 6: 科大讯飞声纹实现

**用户故事:** 作为系统操作员,我希望使用科大讯飞声纹识别,以便识别会议录音中的说话人。

#### 验收标准

1. IFlyTek_Voiceprint_Provider 应当实现 Voiceprint_Provider 接口
2. 当识别说话人时,IFlyTek_Voiceprint_Provider 应当使用 1:N 搜索对已注册的说话人组进行匹配
3. 当置信度分数模糊时,IFlyTek_Voiceprint_Provider 应当应用分差挽救机制以提高准确性
4. IFlyTek_Voiceprint_Provider 应当为 API 请求实现 HMAC-SHA256 认证
5. 当注册新说话人时,IFlyTek_Voiceprint_Provider 应当验证音频格式要求(16kHz、单声道、16位 WAV)
6. IFlyTek_Voiceprint_Provider 应当实现速率限制以防止 QPS 违规

### 需求 7: LLM 提供商抽象

**用户故事:** 作为开发者,我希望有统一的 LLM 提供商接口,以便可以切换不同的 LLM 服务进行摘要。

#### 验收标准

1. 系统应当定义抽象的 LLM_Provider 接口,包含 generate 方法
2. LLM_Provider 接口应当接受转写文本、提示词实例和语言参数
3. LLM_Provider 接口应当返回生成的文本内容
4. 系统应当支持通过提示词模板控制生成内容的风格与目标

### 需求 8: Gemini LLM 实现

**用户故事:** 作为系统操作员,我希望使用 Gemini 3.0 Pro 进行内容生成,以便生成高质量的会议衍生内容。

#### 验收标准

1. Gemini_LLM_Provider 应当实现 LLM_Provider 接口
2. 当生成内容时,Gemini_LLM_Provider 应当使用 Gemini 3.0 Pro 模型
3. Gemini_LLM_Provider 应当支持基于提示词模板的内容生成
4. Gemini_LLM_Provider 应当解析转写片段,在提示中包含说话人姓名和时间戳
5. 当 API 调用失败时,Gemini_LLM_Provider 应当实现指数退避的重试逻辑
6. 系统应当支持提示词模板作为 Prompt 构建的基础骨架
7. 模型调用时的 Prompt 应当由模板内容、注入参数和会议文本组成

### 需求 9: 数据模型定义

**用户故事:** 作为开发者,我希望有强类型的数据模型,以便确保系统中的数据一致性并及早发现错误。

#### 验收标准

1. 系统应当定义 Segment 模型,包含 text、start_time、end_time、speaker 和 confidence 字段
2. 系统应当定义 TranscriptionResult 模型,包含 segments、full_text、duration、language 和 provider 字段
3. 系统应当定义 SpeakerIdentity 模型,包含 speaker_id、name、confidence 和 metadata 字段
4. 系统应当定义 GeneratedArtifact 模型作为会议生成内容的统一集合模型,包含 artifact_id、task_id、artifact_type、version、prompt_instance 和 content 字段
5. MeetingMinutes 应当作为 GeneratedArtifact 的一种具体类型实现(通过 artifact_type = "meeting_minutes" 区分),而非完全独立的平行实体
6. 所有版本管理、提示词绑定应当基于 GeneratedArtifact 维度进行
7. 当创建数据模型实例时,系统应当验证所有必需字段和数据类型
8. 系统应当使用 Pydantic 进行数据模型验证和序列化

### 需求 10: 配置管理

**用户故事:** 作为系统操作员,我希望有集中的配置管理,以便轻松管理跨环境的 API 密钥和服务设置。

#### 验收标准

1. 系统应当从环境变量加载配置,使用 .env 文件
2. 系统应当为每个提供商定义单独的配置类(VolcanoConfig、AzureConfig、IFlyTekConfig、GeminiConfig)
3. 当配置缺失或无效时,系统应当在启动时抛出描述性验证错误
4. 系统应当支持特定环境的配置文件(development、production、test)
5. 系统应当永远不记录或暴露敏感配置值(API 密钥、密钥)

### 需求 11: 音频处理工具

**用户故事:** 作为开发者,我希望有音频处理工具,以便提取说话人样本并为声纹识别准备音频。

#### 验收标准

1. Audio_Processor 应当基于时间戳范围提取音频片段
2. 当提取片段时,Audio_Processor 应当将音频转换为所需格式(16kHz、单声道、16位 WAV)
3. Audio_Processor 应当在需要时从 TOS 存储下载音频文件
4. Audio_Processor 应当实现智能片段选择(首选 3-6 秒时长)
5. 当音频格式转换失败时,Audio_Processor 应当抛出描述性错误

### 需求 12: 存储操作

**用户故事:** 作为开发者,我希望有存储操作工具,以便管理 TOS 和本地文件系统中的音频文件。

#### 验收标准

1. Storage_Client 应当支持使用自动密钥生成将文件上传到 TOS
2. Storage_Client 应当支持从 TOS 下载文件到本地临时存储
3. Storage_Client 应当支持使用前缀过滤列出 TOS 存储桶中的对象
4. Storage_Client 应当实现本地临时文件的自动清理(处理完成后立即删除)
5. Storage_Client 应当支持配置 TOS 对象的生命周期规则
6. Storage_Client 应当提供生成带过期时间的预签名 URL 用于音频回放
7. 当存储操作失败时,Storage_Client 应当抛出带有操作上下文的描述性错误

### 需求 13: 转写服务

**用户故事:** 作为系统用户,我希望有转写服务,以便将会议音频转换为带有说话人标签的文本。

#### 验收标准

1. Transcription_Service 应当接受音频文件 URL 或本地路径作为输入
2. 当转写时,Transcription_Service 应当首先尝试主 ASR 提供商
3. 如果主 ASR 提供商失败,则 Transcription_Service 应当自动降级到备用提供商
4. Transcription_Service 应当返回标准化的 TranscriptionResult 对象
5. Transcription_Service 应当记录所有转写尝试,包括提供商名称和结果

### 需求 14: 说话人识别服务

**用户故事:** 作为系统用户,我希望有说话人识别服务,以便识别会议中每个片段的说话人。

#### 验收标准

1. Speaker_Recognition_Service 应当接受 TranscriptionResult 和音频源作为输入
2. 当识别说话人时,Speaker_Recognition_Service 应当为每个唯一的说话人标签提取音频样本
3. Speaker_Recognition_Service 应当调用声纹提供商识别每个说话人样本
4. Speaker_Recognition_Service 应当创建从说话人标签到真实姓名的映射
5. 当说话人的声纹识别失败时,Speaker_Recognition_Service 应当保留原始说话人标签
6. Speaker_Recognition_Service 应当返回带有真实说话人姓名的丰富 TranscriptionResult

### 需求 15: ASR 修正服务

**用户故事:** 作为系统用户,我希望基于声纹聚类的 ASR 修正,以便整个转写中的说话人标签更准确。

#### 验收标准

1. Correction_Service 应当接受 TranscriptionResult 和声纹识别结果作为输入
2. 当修正说话人标签时,Correction_Service 应当在所有片段中实现全局身份投票
3. Correction_Service 应当检测并清理异常的说话人标签分配
4. Correction_Service 应当计算修正前后的 DER(说话人区分错误率)
5. Correction_Service 应当返回带有改进说话人标签的修正 TranscriptionResult

### 需求 16: 摘要服务

**用户故事:** 作为系统用户,我希望有摘要服务,以便从转写生成结构化的会议纪要。

#### 验收标准

1. Summarization_Service 应当接受 TranscriptionResult 和提示词实例作为输入
2. 当生成内容时,Summarization_Service 应当使用说话人姓名和时间戳格式化转写
3. Summarization_Service 应当基于提示词模板构建完整 Prompt
4. Summarization_Service 应当调用 LLM 提供商生成内容
5. Summarization_Service 应当从转写中的唯一说话人提取参与者列表

### 需求 17: 会议管线编排

**用户故事:** 作为系统用户,我希望有端到端的会议管线,以便通过单次调用将音频文件处理为会议纪要。

#### 验收标准

1. Meeting_Pipeline 应当接受音频文件输入(单个文件或用于连接的文件列表)
2. 当处理会议时,Meeting_Pipeline 应当按顺序执行阶段:转写、说话人识别、修正、摘要
3. Meeting_Pipeline 应当支持可选的阶段跳过(例如,跳过说话人识别)
4. Meeting_Pipeline 应当通过状态转换跟踪处理状态(PENDING、TRANSCRIBING、IDENTIFYING、SUMMARIZING、COMPLETED、FAILED)
5. Meeting_Pipeline 应当提供 get_status 方法,返回当前状态和进度信息
6. 当任何阶段失败时,Meeting_Pipeline 应当转换到 FAILED 状态并保留错误详情
7. Meeting_Pipeline 应当在成功完成时返回完整的 GeneratedArtifact(type=meeting_minutes)对象,而非独立的 MeetingMinutes

### 需求 18: 音频文件连接

**用户故事:** 作为系统用户,我希望将多个音频文件作为单个会议处理,以便处理多段录制的会议。

#### 验收标准

1. 当提供多个音频文件时,系统应当按提供的顺序连接它们
2. 系统应当调整转写结果中的时间戳以考虑连接偏移
3. 系统应当保持连接文件之间的音频格式一致性
4. 当连接失败时,系统应当抛出描述性错误,指示哪些文件导致了问题

### 需求 19: 异常处理

**用户故事:** 作为开发者,我希望有全面的异常处理,以便适当地诊断和处理错误。

#### 验收标准

1. 系统应当为每种提供商类型定义自定义异常类(ASRError、VoiceprintError、LLMError)
2. 系统应当为每种失败场景定义自定义异常类(ConfigurationError、AuthenticationError、RateLimitError)
3. 当异常发生时,系统应当包含提供商名称、操作上下文和原始错误详情
4. 系统应当区分可重试和不可重试的错误
5. 系统应当在适当的日志级别记录所有异常及完整堆栈跟踪

### 需求 20: 结构化日志

**用户故事:** 作为系统操作员,我希望有结构化日志,以便监控系统行为并诊断生产中的问题。

#### 验收标准

1. 系统应当对所有日志条目使用 JSON 格式的结构化日志
2. 当记录时,系统应当包含时间戳、日志级别、模块名称和消息
3. 系统应当包含请求 ID 或关联 ID 以跟踪跨服务的操作
4. 系统应当支持可配置的日志级别(DEBUG、INFO、WARNING、ERROR)
5. 系统应当实现日志轮转以防止磁盘空间耗尽
6. 系统应当永远不记录敏感信息(API 密钥、音频内容、个人数据)

### 需求 21: Web API 接口

**用户故事:** 作为前端开发者,我希望有 RESTful API 端点,以便将会议管线集成到 Web 应用程序中。

#### 验收标准

1. 系统应当提供接受音频 URL 的 POST /api/v1/transcribe 端点
2. 系统应当提供用于完整管线执行的 POST /api/v1/process 端点
3. 系统应当提供用于进度跟踪的 GET /api/v1/status/{job_id} 端点
4. 当收到 API 请求时,系统应当验证输入参数并为无效请求返回 400 错误
5. 当处理完成时,系统应当返回带有成功状态和数据的标准化 JSON 响应
6. 当发生错误时,系统应当返回适当的 HTTP 状态码(400、401、500)及错误详情

### 需求 22: API 请求/响应模型

**用户故事:** 作为前端开发者,我希望有明确定义的 API 模式,以便可靠地与后端集成。

#### 验收标准

1. 系统应当为所有 API 请求体定义 Pydantic 模型
2. 系统应当为所有 API 响应体定义 Pydantic 模型
3. 系统应当从 API 模式自动生成 OpenAPI 文档
4. 当 API 模式更改时,系统应当保持向后兼容性或对 API 进行版本控制
5. 系统应当在处理之前根据定义的模式验证所有传入请求

### 需求 23: 依赖注入

**用户故事:** 作为开发者,我希望有依赖注入,以便轻松测试组件和交换实现。

#### 验收标准

1. 系统应当使用工厂函数创建提供商实例
2. 系统应当对服务构造函数使用依赖注入
3. 当运行测试时,系统应当允许通过依赖注入模拟提供商
4. 系统应当为配置对象实现单例模式
5. 系统应当为 API 端点使用 FastAPI 的依赖注入系统

### 需求 24: 测试基础设施

**用户故事:** 作为开发者,我希望有全面的测试基础设施,以便确保代码质量并捕获回归。

#### 验收标准

1. 系统应当为所有提供商实现提供单元测试
2. 系统应当为服务编排提供集成测试
3. 系统应当为所有端点提供 API 测试
4. 系统应当使用 pytest 作为测试框架
5. 系统应当达到最低 80% 的代码覆盖率
6. 系统应当为示例音频文件和 API 响应使用测试夹具

### 需求 25: 性能监控

**用户故事:** 作为系统操作员,我希望有性能监控,以便跟踪系统性能并识别瓶颈。

#### 验收标准

1. 系统应当跟踪每个管线阶段的处理时间
2. 系统应当跟踪外部服务调用的 API 响应时间
3. 系统应当跟踪每个提供商的成功和失败率
4. 系统应当以与监控工具兼容的格式公开指标
5. 当性能下降时,系统应当记录带有性能指标的警告

### 需求 26: 版本控制与代码管理

**用户故事:** 作为开发者,我希望使用 Git 进行版本控制,以便跟踪代码变更、协作开发并维护代码历史。

#### 验收标准

1. 系统应当使用 Git 作为版本控制系统
2. 系统应当包含 .gitignore 文件,排除临时文件、缓存、配置密钥和生成的文件
3. 系统应当在 README.md 中提供清晰的项目设置和开发指南
4. 系统应当使用语义化版本号(Semantic Versioning)进行版本标记
5. 系统应当在提交消息中遵循约定式提交(Conventional Commits)规范
6. 系统应当永远不将敏感信息(API 密钥、密码、证书)提交到版本控制

### 需求 27: 任务创建与配置 API

**用户故事:** 作为前端开发者,我希望提交任务创建请求,以便启动会议录音的处理流程。

#### 验收标准

1. 系统应当提供 POST /api/v1/tasks 端点接受任务创建请求
2. 当创建任务时,系统应当接受音频文件列表(文件流或文件路径)
3. 当提供多个音频文件时,系统应当接受排序索引数组以指定拼接顺序
4. 系统应当接受提示词模板 ID 参数(用于选择生成策略)
5. 系统应当接受提示词参数(如会议描述信息)
6. 系统应当返回唯一的任务 ID 用于后续状态查询
7. 系统应当验证所有必需参数并为缺失或无效参数返回 400 错误
8. 系统应当接受 asr_language 参数(ASR 识别语言,默认 zh-CN+en-US 中英文混合)
9. 系统应当接受 output_language 参数(输出语言,默认 zh-CN 中文)

### 需求 28: 任务状态查询 API

**用户故事:** 作为前端开发者,我希望查询任务处理状态,以便向用户显示实时进度。

#### 验收标准

1. 系统应当提供 GET /api/v1/tasks/{task_id}/status 端点
2. 当查询状态时,系统应当返回当前处理阶段(PENDING、TRANSCRIBING、IDENTIFYING、CORRECTING、SUMMARIZING、COMPLETED、FAILED)
3. 系统应当返回每个阶段的进度百分比
4. 系统应当返回预计剩余时间(如果可计算)
5. 当任务失败时,系统应当返回错误详情和失败阶段
6. 系统应当支持实时或准实时的任务状态获取能力
7. Phase 1 应当优先实现轮询 + 长轮询(long polling)机制
8. Phase 2 可选实现 SSE 或 WebSocket 以提升实时性
9. 当前阶段优先保证状态可查询与稳定性

### 需求 29: 转写结果修正 API

**用户故事:** 作为前端用户,我希望修正转写错误,以便提高最终纪要的准确性。

#### 验收标准

1. 系统应当提供 PUT /api/v1/tasks/{task_id}/transcript 端点接受修正后的转写文本
2. 当接收修正文本时,系统应当保留原始转写结果作为历史记录
3. 系统应当使用修正后的文本重新生成会议纪要
4. 系统应当支持部分修正(仅修改特定片段)
5. 系统应当记录修正操作的时间戳和操作者信息

### 需求 30: 纪要重新生成 API

**用户故事:** 作为前端用户,我希望使用新的提示词模板重新生成内容,以便调整输出内容的重点。

#### 验收标准

1. 系统应当提供 POST /api/v1/tasks/{task_id}/regenerate 端点
2. 当重新生成时,系统应当接受新的提示词模板 ID
3. 系统应当接受新的提示词参数
4. 系统应当接受修正后的转写文本(如果有)
5. 系统应当保留之前生成的内容版本作为历史记录
6. 系统应当返回新生成的内容及版本号

### 需求 31: 任务确认与归档 API

**用户故事:** 作为前端用户,我希望确认纪要内容并归档任务,以便完成处理流程。

#### 验收标准

1. 系统应当提供 POST /api/v1/tasks/{task_id}/confirm 端点
2. 当确认任务时,系统应当接受确认项的布尔值状态(关键结论已确认、负责人无误等)
3. 系统应当接受责任人信息(姓名或账号 ID)
4. 系统应当验证所有必需的确认项都已勾选
5. 当确认项未完成时,系统应当返回 400 错误并指明缺失项
6. 系统应当在生成内容或其元数据中注入责任人水印信息,用于责任确认与审计溯源
7. 责任人水印至少应以文本形式体现,具体展示方式(如页面展示、复制内容中的文本表现)由前端实现决定
8. 系统应当将任务状态更新为 ARCHIVED
9. 系统应当在会议纪要交付前提供人工确认机制,明确区分"AI 自动生成内容"与"用户确认后的最终内容",以建立清晰的使用责任边界

### 需求 32: 热词库管理 API

**用户故事:** 作为系统管理员,我希望管理热词库,以便持续提升转写精度。

#### 验收标准

1. 系统应当提供 POST /api/v1/hotwords 端点添加新热词
2. 系统应当提供 GET /api/v1/hotwords 端点列出所有热词
3. 系统应当提供 DELETE /api/v1/hotwords/{word_id} 端点删除热词
4. 当添加热词时,系统应当接受词条文本、权重和作用域参数(global、tenant、user)
5. 系统应当支持按作用域隔离热词(全局热词、租户热词、用户热词)
6. 当转写时,系统应当合并适用的热词(用户 > 租户 > 全局)
7. 系统应当自动同步热词到火山引擎 ASR 服务
8. 系统应当记录热词的添加时间和添加者信息
9. 系统应当支持根据会议类型或配置加载领域相关词汇,以提升转写准确率
10. 不同语音识别服务对词汇增强能力支持程度不同,系统应当在能力范围内自动适配
11. 系统应当支持为热词集指定适配的 asr_language,并在任务创建时验证热词集语言与任务 asr_language 的兼容性

### 需求 33: 任务元数据模型

**用户故事:** 作为开发者,我希望有完整的任务元数据模型,以便管理任务的完整生命周期。

#### 验收标准

1. 系统应当定义 TaskMetadata 模型包含 task_id、audio_files、file_order、meeting_type、asr_language、output_language 字段
2. 系统应当定义 TaskStatus 模型包含 stage、progress、estimated_time、error_details 字段
3. 系统应当定义 TranscriptCorrection 模型包含 original_text、corrected_text、corrected_by、corrected_at 字段
4. 系统应当定义 ConfirmationStatus 模型包含各确认项的布尔值和责任人信息
5. 系统应当定义 TaskHistory 模型记录任务的所有版本和操作历史
6. 所有模型应当使用 Pydantic 进行验证和序列化
7. TaskMetadata 的 asr_language 字段应当默认为 zh-CN+en-US(中英文混合)
8. TaskMetadata 的 output_language 字段应当默认为 zh-CN(中文)

### 需求 34: 任务持久化与数据生命周期

**用户故事:** 作为系统操作员,我希望任务数据被持久化并有明确的生命周期策略,以便支持长时间运行的任务、历史查询和成本控制。

#### 验收标准

1. 系统应当将任务元数据持久化到数据库
2. 系统应当保存所有中间结果(转写、识别、修正、摘要)到数据库
3. 系统应当将原始音频文件上传到 TOS 对象存储
4. 原始音频的保留策略应当与任务状态和用户操作历史相关
5. 对于未确认、存在修正历史或需要回放的任务,系统应当支持延长音频保留期
6. 具体保留时长与策略应当作为可配置项,默认策略为:原始音频保留 7 天用于回放和修正,7 天后自动归档到低频存储或删除
7. 对于需要延长保留的音频,系统应当默认延长至任务 ARCHIVED 后 30 天,或最长 90 天(可配置)
8. 系统应当永久保存摘要和文本结果(或根据配置保留指定时长)
9. 系统应当支持任务的暂停和恢复
10. 系统应当实现任务元数据的自动清理策略(如 90 天后删除已归档任务)
11. 系统应当提供任务历史查询接口
12. 系统应当在音频文件删除前验证相关任务已完成且不再需要回放
13. 系统应当支持长时间会议音频的稳定处理,避免因服务重启或更新导致已开始的会议任务异常中断

### 需求 35: 并发任务处理

**用户故事:** 作为系统操作员,我希望支持并发处理多个任务,以便提高系统吞吐量。

#### 验收标准

1. 系统应当使用任务队列管理并发任务
2. 系统应当支持可配置的最大并发任务数
3. 系统应当实现任务优先级队列
4. 当系统负载过高时,系统应当拒绝新任务并返回 503 错误
5. 系统应当提供任务队列状态查询接口

## 非功能性需求

### 需求 36: 异步任务处理与可靠性保证

**用户故事:** 作为系统用户,我希望提交任务后可以离开页面,系统在后台稳定处理,即使服务重启也不会丢失任务。

#### 验收标准

1. 系统应当采用异步任务处理机制,用户提交任务后立即获得任务 ID,无需等待处理完成
2. 系统应当支持任务排队、自动重试和状态恢复
3. 当后台服务重启或短暂异常时,系统应当确保会议处理任务不会丢失或无限卡死
4. 系统应当在任务失败时提供明确的错误信息和重试选项
5. 系统应当支持用户随时查询任务处理进度和状态

### 需求 37: 任务状态机

**用户故事:** 作为开发者,我希望有明确的任务状态机,以便跟踪任务生命周期并支持重试和恢复。

#### 验收标准

1. 系统应当定义任务状态枚举:PENDING、QUEUED、RUNNING、SUCCESS、FAILED、PARTIAL_SUCCESS
2. 系统应当在任务状态转换时记录时间戳和转换原因
3. 当任务失败时,系统应当保留失败状态和错误详情
4. 系统应当支持从 FAILED 状态重试任务
5. 系统应当支持 PARTIAL_SUCCESS 状态表示部分模型成功部分失败
6. 系统应当提供状态转换历史查询接口

### 需求 38: 多模型编排管道

**用户故事:** 作为系统架构师,我希望模型调用是可配置的管道,以便灵活切换供应商和支持 A/B 测试。

#### 验收标准

1. 系统应当将模型调用定义为 Pipeline 由多个 Step 组成
2. 每个 Step 应当声明使用的模型、输入输出格式和可替换实现
3. 系统应当支持在配置文件中定义 Pipeline 而不是硬编码
4. 系统应当支持为不同会议类型配置不同的 Pipeline
5. 系统应当支持 Step 级别的超时和重试配置
6. 系统应当记录每个 Step 的执行时间和结果

### 需求 39: 失败隔离与降级

**用户故事:** 作为系统操作员,我希望单个模型失败不导致整体失败,以便提供部分结果。

#### 验收标准

1. 当 Pipeline 中某个 Step 失败时,系统应当继续执行后续非依赖 Step
2. 系统应当支持跳过失败的可选 Step
3. 系统应当返回部分结果并标注哪些 Step 失败
4. 系统应当在响应中包含失败原因和建议的补救措施
5. 系统应当支持配置 Step 的必需性(required/optional)

### 需求 40: 成本预估

**用户故事:** 作为系统用户,我希望在处理前看到成本预估,以便做出知情决策。

#### 验收标准

1. 系统应当提供 POST /api/v1/tasks/estimate 端点进行成本预估
2. 当预估成本时,系统应当基于音频时长计算 ASR 成本
3. 系统应当基于预期输入和输出 Token 数计算 LLM 成本
4. 系统应当返回总成本和各模型费用拆分
5. 系统应当在任务完成后记录实际成本并与预估对比
6. 系统应当提供成本历史查询接口

### 需求 41: 成本与配额监控

**用户故事:** 作为系统用户,我希望了解任务处理成本,并在配额不足时得到明确提示,以便合理规划使用。

#### 验收标准

1. 系统应当对外部 AI 服务的配额与调用状态进行监控
2. 当可用配额不足或服务异常时,系统应当通过状态提示或通知机制告知用户
3. 系统应当提供成本预估功能,让用户在提交任务前了解大致费用
4. 系统应当记录每个任务的实际成本,并提供成本查询接口
5. 系统应当在配额即将耗尽时发送告警通知
6. 当配额不足导致任务失败时,系统应当返回明确的错误信息,而非静默失败

### 需求 42: API 鉴权机制

**用户故事:** 作为系统管理员,我希望所有 API 都需要鉴权,以便保护系统资源和追踪使用情况。

#### 验收标准

1. 系统应当要求所有 API 请求包含 Bearer Token 或 API Key
2. 当请求未包含有效鉴权信息时,系统应当返回 401 错误
3. 系统应当验证 Token 的有效性和过期时间
4. 系统应当将 API Key 绑定到用户、项目和成本额度
5. 系统应当为每个 API Key 实现调用速率限制
6. 系统应当记录每次 API 调用的鉴权信息用于审计

### 需求 43: 任务重试与幂等性

**用户故事:** 作为系统开发者,我希望任务执行是幂等的,以便安全地重试失败任务。

#### 验收标准

1. Worker 应当支持失败任务的自动重试
2. 系统应当实现指数退避重试策略
3. 系统应当保证同一任务多次执行产生相同结果
4. 系统应当防止重复计费(同一任务 ID 只计费一次)
5. 系统应当记录每次重试的时间和原因
6. 系统应当在达到最大重试次数后将任务标记为永久失败
7. 重新生成视为新的一次 LLM 调用,正常计费(前端可显示预估)

### 需求 44: 审计日志

**用户故事:** 作为系统管理员,我希望有完整的审计日志,以便追踪操作、调试问题和财务对账。

#### 验收标准

1. 系统应当记录每个任务使用的模型列表
2. 系统应当记录每个任务的输入规模(音频时长、文本长度)
3. 系统应当记录每个任务的实际成本和成本拆分
4. 系统应当记录每个任务的成功或失败原因
5. 系统应当记录所有 API 调用的请求者、时间和参数
6. 系统应当提供审计日志查询和导出接口
7. 审计日志应当保留至少 90 天

### 需求 45: 性能指标

**用户故事:** 作为系统操作员,我希望监控系统性能指标,以便识别瓶颈和优化系统。

#### 验收标准

1. 系统应当跟踪每个 Pipeline Step 的平均执行时间
2. 系统应当跟踪任务队列的长度和等待时间
3. 系统应当跟踪 Worker 的 CPU 和内存使用率
4. 系统应当跟踪外部 API 调用的成功率和响应时间
5. 系统应当以 Prometheus 格式暴露指标
6. 系统应当在性能指标异常时触发告警

### 需求 46: 提示词模板管理

**用户故事:** 作为系统管理员,我希望管理提示词模板,以便为不同场景提供合适的生成策略。

#### 验收标准

1. 系统应当支持提示词模板作为可枚举、可选择、可复用的配置实体
2. 每个提示词模板应当包含模板 ID、标题、用户可读说明、提示词正文(含占位符)、支持的语言列表和参数定义
3. 提示词模板应当用于控制纪要、笔记或其他生成类输出的风格与目标
4. 系统应当预置一组 global 作用域的模板,对所有用户可见但不可修改
5. 预置模板应当由系统管理员在代码或数据库中维护,版本升级时可更新
6. 用户应当可以创建并管理与自身账号绑定的私有模板
7. 当前阶段不要求支持跨用户共享或租户级模板,但应在语义上预留扩展空间
8. 用户应当通过提示词模板广场或弹窗选择模板(而非选择会议类型)
9. 系统应当提供 GET /api/v1/prompt-templates 端点列出所有可用模板
10. 系统应当提供 GET /api/v1/prompt-templates/{id} 端点获取模板详情
11. 模板参数定义应当包含参数名称、类型、是否必需和默认值

### 需求 47: 提示词实例与参数注入

**用户故事:** 作为前端用户,我希望基于模板创建提示词实例并注入参数,以便生成更符合需求的内容。

#### 验收标准

1. 系统应当支持提示词实例(Prompt Instance)作为基于模板创建的具体 Prompt
2. 提示词实例应当包含模板 ID、语言和参数值
3. 参数值应当包含会议描述信息(如标题、主题、背景、关注重点等)
4. 系统应当将参数值注入到模板的占位符中生成完整 Prompt
5. LLM 提供商应当不感知参数的字段结构,只感知拼接后的 Prompt
6. 系统应当在任务创建时接受提示词实例
7. 系统应当在重新生成时支持修改提示词实例的参数
8. 系统应当支持语言切换通过修改提示词实例的语言参数实现

### 需求 48: 多类型生成内容与版本管理

**用户故事:** 作为前端用户,我希望从同一会议生成多种类型的内容,并管理每种内容的多个版本。

#### 验收标准

1. 系统应当支持从同一会议生成多种类型的衍生内容(meeting_minutes/action_items/summary_notes 等)
2. 每种衍生内容类型应当可以有多个生成版本
3. 每个生成版本应当绑定特定的提示词实例(模板 ID + 语言 + 参数)
4. 系统应当记录每个版本的生成时间、使用的提示词实例和生成内容
5. 系统应当支持查询特定类型的所有版本
6. 系统应当支持切换提示词模板或修改参数重新生成内容
7. 版本之间应当不共享 Prompt,不自动继承模板(除非用户明确选择)
8. 系统应当提供 GET /api/v1/tasks/{task_id}/artifacts 端点列出所有衍生内容(按类型分组)
9. 系统应当提供 GET /api/v1/tasks/{task_id}/artifacts/{type}/versions 端点列出特定类型的所有版本
10. 系统应当提供 POST /api/v1/tasks/{task_id}/artifacts/{type}/generate 端点生成新版本
11. 会议衍生内容应当作为核心集合模型,关系为 Meeting → Generated_Artifacts (1:N)
12. MeetingMinutes 应当作为 Artifact 的一个子类型,即 Artifact(type = meeting_minutes)
